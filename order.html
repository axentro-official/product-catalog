<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>إتمام الطلب</title>

  <style>
    :root{
      --bg1:#0b1020; --bg2:#0f172a;
      --stroke:#ffffff1a; --text:#e5e7eb; --muted:#94a3b8;
      --shadow:0 18px 50px rgba(0,0,0,.45);
      --radius:18px;
      --ok:#22c55e; --warn:#facc15; --bad:#ef4444;
      --container-max:980px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: system-ui, -apple-system, "Segoe UI", Tahoma, Arial;
      color:var(--text);
      background:
        radial-gradient(900px 500px at 10% 10%, rgba(96,165,250,.25), transparent 55%),
        radial-gradient(700px 500px at 90% 20%, rgba(167,139,250,.18), transparent 55%),
        linear-gradient(180deg, var(--bg1), var(--bg2));
      padding:18px;
      min-height:100vh;
      -webkit-font-smoothing:antialiased;
    }
    a{color:inherit;text-decoration:none}
    .wrap{max-width:var(--container-max);margin:0 auto}
    .top{
      display:flex;justify-content:space-between;align-items:center;gap:12px;
      padding:12px 14px;border:1px solid var(--stroke);
      border-radius:18px;background:rgba(255,255,255,.06);
      box-shadow:var(--shadow);backdrop-filter:blur(10px);
      flex-wrap:wrap;
    }
    .back{
      padding:10px 12px;border-radius:14px;
      border:1px solid var(--stroke);background:rgba(255,255,255,.06);
      display:inline-flex;align-items:center;gap:8px;
    }
    .title{font-weight:900}

    .card{
      margin-top:14px;padding:14px;
      border:1px solid var(--stroke);border-radius:var(--radius);
      background:rgba(255,255,255,.06);box-shadow:var(--shadow);
    }

    .note{
      margin-top:12px;padding:12px;border-radius:16px;
      border:1px solid rgba(96,165,250,.25);
      background:rgba(96,165,250,.08);
      color:#dbeafe;font-weight:800;line-height:1.7;
    }

    .seg{
      display:flex;gap:14px;flex-wrap:wrap;
      padding:10px;border-radius:14px;
      border:1px solid var(--stroke);
      background:rgba(255,255,255,.04);
      margin-top:10px;
    }

    label{display:block;font-size:12px;color:var(--muted);margin:10px 0 6px}
    input, select, textarea{
      width:100%;padding:12px;border-radius:14px;
      border:1px solid var(--stroke);
      background:rgba(255,255,255,.06);color:var(--text);
      outline:none;font-size:14px;
    }
    .row2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media(max-width:720px){.row2{grid-template-columns:1fr}}

    .items{
      display:flex; flex-direction:column; gap:10px;
      margin-top:10px;
    }
    .item{
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.05);
      border-radius:16px;
      padding:10px;
      display:flex; gap:10px; align-items:center;
      justify-content:space-between;
      flex-wrap:wrap;
    }
    .thumb{
      width:56px;height:56px;border-radius:14px;
      border:1px solid var(--stroke);
      object-fit:cover;background:rgba(255,255,255,.04);
      flex:0 0 auto;
    }
    .iInfo{flex:1; min-width:0}
    .iName{font-weight:900; font-size:13px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis}
    .iMeta{font-size:11px;color:var(--muted); margin-top:3px}
    .status{font-weight:900}
    .st-available{color:var(--ok)}
    .st-low{color:var(--warn)}
    .st-out{color:var(--bad)}
    .st-unknown{color:#cbd5e1}

    .qtyBox{display:flex; align-items:center; gap:6px}
    .qBtn{
      width:40px;height:40px;border-radius:12px;
      border:1px solid var(--stroke);
      background:rgba(255,255,255,.06);
      color:var(--text);
      cursor:pointer;font-weight:900;
      display:inline-flex;align-items:center;justify-content:center;
    }
    .qVal{
      min-width:46px;text-align:center;
      border:1px solid var(--stroke);
      background:rgba(255,255,255,.04);
      border-radius:12px;
      padding:7px 6px;
      font-weight:900;font-size:14px;
    }
    .rmBtn{
      margin-top:6px;
      font-size:13px;
      color:#fca5a5;
      cursor:pointer;
      user-select:none;
      background:transparent;border:none;
    }

    .btns{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
    button{
      cursor:pointer;border-radius:16px;padding:12px 14px;
      font-weight:900;border:1px solid var(--stroke);
      background:rgba(255,255,255,.06);color:var(--text);
      flex:1;
      transition: opacity .15s ease, transform .15s ease;
    }
    button:active{transform: translateY(1px)}
    button:disabled{
      opacity:.45;
      cursor:not-allowed;
      transform:none;
      filter:saturate(.85);
    }

    .primary{
      border-color:rgba(96,165,250,.45);
      background:linear-gradient(135deg, rgba(96,165,250,.30), rgba(167,139,250,.18));
    }
    .success{
      margin-top:12px;padding:12px;border-radius:16px;
      border:1px solid rgba(34,197,94,.25);
      background:rgba(34,197,94,.10);
      color:#dcfce7;font-weight:900;line-height:1.7;
      display:none;
    }
    .empty{
      padding:14px;
      border:1px dashed var(--stroke);
      border-radius: var(--radius);
      color:var(--muted);
      text-align:center;
    }

    /* toast */
    .toast{
      position:fixed; bottom:16px; left:16px;
      padding:10px 12px;border-radius:12px;border:1px solid var(--stroke);
      background:rgba(15,23,42,.9); color:var(--text); z-index:999;
      display:none; font-weight:900;
    }
  </style>
</head>

<body>
<div class="wrap">
  <div class="top">
    <a class="back" href="./" aria-label="رجوع للكتالوج">← رجوع للكتالوج</a>
    <div class="title">إتمام الطلب</div>
    <div></div>
  </div>

  <div class="card" aria-live="polite">
    <div style="font-weight:900">محتويات السلة</div>
    <div id="cartBox" class="items"></div>

    <div class="note" id="note" role="status"></div>

    <div style="margin-top:10px;font-weight:900">نوع الطلب</div>
    <div class="seg">
      <label><input type="radio" name="type" value="قطاعي" checked> قطاعي</label>
      <label><input type="radio" name="type" value="جملة"> جملة</label>
    </div>
  </div>

  <div class="card">
    <div style="font-weight:900;margin-bottom:8px">بيانات العميل</div>

    <div class="row2">
      <div>
        <label for="name">الاسم</label>
        <input id="name" placeholder="اكتب اسمك" autocomplete="name" />
      </div>
      <div>
        <label for="phone">رقم الموبايل</label>
        <input id="phone" placeholder="مثال: 01xxxxxxxxx أو +201xxxxxxxxx" inputmode="tel" />
      </div>
    </div>

    <label for="address">العنوان</label>
    <textarea id="address" placeholder="المحافظة / المنطقة / تفاصيل" rows="2"></textarea>

    <div class="btns">
      <button class="primary" id="sendOrder">إرسال الطلب (واتساب)</button>
      <button id="clear">تفريغ السلة</button>
    </div>

    <div id="ok" class="success" role="status"></div>
  </div>
</div>

<div id="toast" class="toast" role="status" aria-live="polite"></div>

<script>
  /* ====== بياناتك ====== */
  const OWNER_WA = "201146476993";

  /* ====== نفس API بتاع Google Sheets ====== */
  const API_URL = "https://script.google.com/macros/s/AKfycbwsPPw3UiW6TBngBcbFxY4E8rB7JYgK1W2LRn0WaS9C7OitA1FgZ1vAz9Qr1u_ojlZ8/exec";

  const LS_KEY = "AX_CART_V1";
  const cartBox = document.getElementById("cartBox");
  const note = document.getElementById("note");
  const ok = document.getElementById("ok");
  const sendBtn = document.getElementById("sendOrder");
  const toastEl = document.getElementById("toast");

  const IMG_PLACEHOLDER = "https://via.placeholder.com/600x400?text=No+Image";
  function resolveImageById(id){
    return `images/${id}.webp`;
  }

  const PROD_CACHE_KEY = "AX_PRODUCTS_CACHE_V1";
  const PROD_CACHE_TS  = "AX_PRODUCTS_CACHE_TS_V1";
  const CACHE_TTL_MS   = 10 * 60 * 1000;

  let products = [];

  function statusClass(av){
    if(av === "Low stock") return "st-low";
    if(av === "Out of stock") return "st-out";
    if(av === "Available") return "st-available";
    return "st-unknown";
  }

  function getType(){
    return document.querySelector("input[name='type']:checked").value;
  }

  function setNote(){
    note.textContent =
      getType()==="جملة"
      ? "✅ تم استلام طلب الجملة. سيتم مراجعة الطلب وتحديد السعر النهائي والتواصل معك."
      : "✅ تم استلام طلبك بنجاح. سيتم التواصل معك لتأكيد الطلب وإرسال الفاتورة.";
  }

  function showToast(msg){
    toastEl.textContent = msg;
    toastEl.style.display = "block";
    clearTimeout(showToast._t);
    showToast._t = setTimeout(()=> toastEl.style.display="none", 2200);
  }

  function getCart(){
    try{
      const raw = localStorage.getItem(LS_KEY);
      return raw ? JSON.parse(raw) : [];
    }catch(e){ return []; }
  }

  function setCart(items){
    localStorage.setItem(LS_KEY, JSON.stringify(items));
  }

  function ensureCartInitialized(){
    if(localStorage.getItem(LS_KEY) === null){
      setCart([]);
    }
  }

  function setQty(pid, qty){
    const cart = getCart();
    const idx = cart.findIndex(x=>x.id===pid);
    if(idx<0) return;
    cart[idx].qty = Math.max(1, Number(qty)||1);
    setCart(cart);
    renderCart();
  }

  function removeItem(pid){
    setCart(getCart().filter(x=>x.id!==pid));
    renderCart();
    showToast("تم حذف الصنف");
  }

  function findProduct(pid){
    return products.find(x=>x.id===pid) || null;
  }

  function renderCart(){
    const cart = getCart();
    cartBox.innerHTML = "";

    if(cart.length === 0){
      cartBox.innerHTML = `<div class="empty">السلة فارغة. ارجع للكتالوج وأضف منتجات.</div>`;
      return;
    }

    cart.forEach(it=>{
      const p = findProduct(it.id);

      const safe = p || {
        id: it.id,
        name: "منتج غير متاح (تم تحديث الكتالوج)",
        category: "—",
        availability: "Unknown"
      };

      const row = document.createElement("div");
      row.className = "item";

      row.innerHTML = `
        <div style="display:flex;align-items:center;gap:12px;flex:1;min-width:0">
          <img class="thumb" loading="lazy" decoding="async" src="${resolveImageById(safe.id)}"
            onerror="this.onerror=null;this.src='${IMG_PLACEHOLDER}'" alt="${safe.name}">
          <div class="iInfo">
            <div class="iName">${safe.name}</div>
            <div class="iMeta">
              ${safe.category} •
              <span class="status ${statusClass(safe.availability)}">${safe.availability}</span> •
              ${safe.id}
            </div>
          </div>
        </div>

        <div style="display:flex;align-items:center;gap:12px;">
          <div class="qtyBox" aria-label="كمية المنتج">
            <button class="qBtn" data-minus="${safe.id}" aria-label="إنقاص">−</button>
            <div class="qVal" aria-live="polite">${Number(it.qty)||1}</div>
            <button class="qBtn" data-plus="${safe.id}" aria-label="زيادة">+</button>
          </div>
          <button class="rmBtn" data-rm="${safe.id}" aria-label="حذف من السلة">حذف</button>
        </div>
      `;

      cartBox.appendChild(row);
    });

    cartBox.querySelectorAll("[data-plus]").forEach(b=>{
      b.onclick = ()=> {
        const id = b.getAttribute("data-plus");
        const cart = getCart();
        const it = cart.find(x=>x.id===id);
        setQty(id, (Number(it?.qty)||1) + 1);
      };
    });

    cartBox.querySelectorAll("[data-minus]").forEach(b=>{
      b.onclick = ()=> {
        const id = b.getAttribute("data-minus");
        const cart = getCart();
        const it = cart.find(x=>x.id===id);
        setQty(id, Math.max(1, (Number(it?.qty)||1) - 1));
      };
    });

    cartBox.querySelectorAll("[data-rm]").forEach(b=>{
      b.onclick = ()=> removeItem(b.getAttribute("data-rm"));
      b.onkeydown = (ev)=> { if(ev.key === 'Enter' || ev.key === ' ') removeItem(b.getAttribute("data-rm")); };
    });
  }

  /* ====== التاريخ والوقت (12 ساعة) ====== */
  function formatDateOnly(d){
    const dd = String(d.getDate()).padStart(2,"0");
    const mm = String(d.getMonth()+1).padStart(2,"0");
    const yyyy = d.getFullYear();
    return `${dd}-${mm}-${yyyy}`;
  }

  function formatTimeOnly12(d){
    let h = d.getHours();
    const min = String(d.getMinutes()).padStart(2,"0");
    const ampm = h >= 12 ? "PM" : "AM";
    h = h % 12; if(h === 0) h = 12;
    const hh = String(h).padStart(2,"0");
    return `${hh}:${min} ${ampm}`;
  }

  /* ====== رقم طلب (BS-YYYYMMDD-XXX) ====== */
  function generateOrderId(){
    const d = new Date();
    const y = d.getFullYear();
    const m = String(d.getMonth()+1).padStart(2,"0");
    const day = String(d.getDate()).padStart(2,"0");
    const rnd = Math.floor(100 + Math.random()*900);
    return `BS-${y}${m}${day}-${rnd}`;
  }

  function getStableOrderId(){
    let id = sessionStorage.getItem("BS_ORDER_ID");
    if(!id){
      id = generateOrderId();
      sessionStorage.setItem("BS_ORDER_ID", id);
    }
    return id;
  }

  /* ====== تحقق ====== */
  function validate(){
    const cart = getCart();
    if(!cart.length) return "السلة فارغة.";

    const name = (document.getElementById("name").value||"").trim();
    const phone = (document.getElementById("phone").value||"").trim();
    const address = (document.getElementById("address").value||"").trim();

    if(!name) return "ادخل الاسم.";
    if(!phone) return "ادخل رقم الموبايل.";
    if(!address) return "ادخل العنوان.";

    const p = phone.replace(/\s+/g,"");
    const okPhone = /^01\d{9}$/.test(p) || /^(\+?20)1\d{9}$/.test(p);
    if(!okPhone) return "رقم الموبايل غير صحيح. مثال: 01xxxxxxxxx أو +201xxxxxxxxx";

    const hasOut = cart.some(it=>{
      const pr = findProduct(it.id);
      return pr && pr.availability === "Out of stock";
    });
    if(hasOut) return "فيه صنف غير متاح داخل السلة. احذفه أولاً.";

    return "";
  }

  function buildMsg(){
    const cart = getCart();
    const orderId = getStableOrderId();
    const type = getType();

    const name = (document.getElementById("name").value||"").trim();
    const phone = (document.getElementById("phone").value||"").trim();
    const address = (document.getElementById("address").value||"").trim();

    const now = new Date();
    const dOnly = formatDateOnly(now);
    const tOnly = formatTimeOnly12(now);

    let totalQty = 0;

    const lines = [];
    lines.push("طلب جديد – BS");
    lines.push("------------------------------");
    lines.push("");
    lines.push(`رقم الطلب: ${orderId}`);
    lines.push(`التاريخ: ${dOnly}`);
    lines.push(`الوقت: ${tOnly}`);
    lines.push(`نوع الطلب: ${type}`);
    lines.push("");
    lines.push("الأصناف:");

    cart.forEach((it)=>{
      const pr = findProduct(it.id);
      const safeName = pr?.name ? String(pr.name).trim() : "اسم المنتج";
      const qty = Number(it.qty)||1;
      totalQty += qty;
      lines.push(`- ${it.id} | ${safeName} | كمية: ${qty}`);
    });

    lines.push("");
    lines.push(`إجمالي القطع: ${totalQty}`);
    lines.push("");
    lines.push("العميل:");
    lines.push(name);
    lines.push(phone);
    lines.push(address);
    lines.push("-------------------------------------------------------");

    lines.push(
      type === "جملة"
      ? "تم إرسال طلب الجملة. سيتم مراجعة الطلب وتحديد السعر النهائي والتواصل معكم."
      : "تم إرسال الطلب. سيتم التواصل لتأكيد الطلب وإرسال الفاتورة."
    );

    return lines.join("\n");
  }

  /* ====== كاش المنتجات لتسريع الظهور ====== */
  function saveProductsCache(list){
    localStorage.setItem(PROD_CACHE_KEY, JSON.stringify(list));
    localStorage.setItem(PROD_CACHE_TS, String(Date.now()));
  }

  function loadProductsFromCache(){
    try{
      const raw = localStorage.getItem(PROD_CACHE_KEY);
      const ts = Number(localStorage.getItem(PROD_CACHE_TS) || 0);
      if(!raw) return null;
      const list = JSON.parse(raw);
      if(!Array.isArray(list)) return null;
      return { list, ts };
    }catch(e){
      return null;
    }
  }

  async function fetchProductsFromApi(){
    const res = await fetch(API_URL, { cache: "no-store" });
    if(!res.ok) throw new Error("HTTP " + res.status);
    const data = await res.json();
    return Array.isArray(data) ? data : [];
  }

  async function hydrateProductsFast(){
    const cached = loadProductsFromCache();
    const now = Date.now();
    const hasCache = cached && cached.list && cached.list.length;

    if(hasCache){
      products = cached.list;
      renderCart();
    } else {
      products = [];
      renderCart();
      if(getCart().length){
        cartBox.insertAdjacentHTML("afterbegin", `<div class="empty" style="margin-bottom:10px">جارٍ تحميل بيانات المنتجات...</div>`);
      }
    }

    const cacheFresh = hasCache && (now - cached.ts) < CACHE_TTL_MS;

    const doFetch = async () => {
      try{
        const freshList = await fetchProductsFromApi();
        products = freshList;
        saveProductsCache(freshList);
        renderCart();
      }catch(err){
        console.error(err);
        // عرض ملاحظة واضحة عند فشل التحميل
        if(!hasCache && getCart().length){
          note.textContent = "⚠️ ملاحظة: لم يتم تحميل بيانات المنتجات من الشيت الآن. يمكنك إرسال الطلب، لكن بعض أسماء/حالات الأصناف قد لا تكون محدثة.";
        } else {
          showToast("تعذر تحديث بيانات الكتالوج، يتم عرض النسخة المخزنة إن وُجدت.");
        }
      }
    };

    if(cacheFresh){
      setTimeout(doFetch, 400);
    } else {
      await doFetch();
    }
  }

  document.querySelectorAll("input[name='type']").forEach(r=> r.addEventListener("change", setNote));
  setNote();

  document.getElementById("clear").addEventListener("click", ()=>{
    setCart([]);
    renderCart();
    ok.style.display="none";
    sessionStorage.removeItem("BS_ORDER_ID");
    showToast("تم تفريغ السلة");
  });

  sendBtn.addEventListener("click", ()=>{
    const err = validate();
    if(err){
      showToast(err);
      return;
    }

    const oldText = sendBtn.textContent;
    sendBtn.disabled = true;
    sendBtn.textContent = "جارٍ فتح واتساب...";

    const msg = buildMsg();
    const waUrl = `https://wa.me/${OWNER_WA}?text=${encodeURIComponent(msg)}`;
    window.open(waUrl, "_blank");

    ok.style.display="block";
    ok.textContent =
      (getType()==="جملة")
      ? "✅ تم إرسال طلب الجملة بنجاح. سيتم مراجعة الطلب والتواصل معك."
      : "✅ تم إرسال الطلب بنجاح. سيتم التواصل لتأكيده وإرسال الفاتورة.";

    setCart([]);
    renderCart();
    sessionStorage.removeItem("BS_ORDER_ID");

    setTimeout(()=>{
      sendBtn.disabled = false;
      sendBtn.textContent = oldText;
      window.location.href = "./";
    }, 1200);
  });

  // Init
  ensureCartInitialized();
  hydrateProductsFast();
</script>
</body>
</html>
