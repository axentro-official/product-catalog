<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Ø¥ØªÙ…Ø§Ù… Ø§Ù„Ø·Ù„Ø¨</title>

  <style>
    :root{
      /* âœ… White + Gold theme (Ø²ÙŠ index) */
      --bg:#ffffff;
      --panel:#ffffff;
      --panel2:#fbfbfd;

      --text:#0f172a;
      --muted:#64748b;

      --stroke:#e6e8ee;
      --stroke2:#f1f5f9;

      --shadow: 0 18px 50px rgba(15,23,42,.10);
      --radius:18px;

      --gold1:#D4AF37;
      --gold2:#B8860B;
      --goldSoft: rgba(212,175,55,.18);
      --goldSoft2: rgba(184,134,11,.12);

      --ok:#16a34a;
      --warn:#d97706;
      --bad:#dc2626;

      --container-max:980px;

      /* mobile action bar */
      --safe-b: env(safe-area-inset-bottom, 0px);
      --bar-h: 74px;
    }

    *{box-sizing:border-box}
    html,body{height:100%}

    body{
      margin:0;
      font-family: system-ui, -apple-system, "Segoe UI", Tahoma, Arial;
      color:var(--text);
      background:
        radial-gradient(900px 480px at 10% 10%, var(--goldSoft), transparent 60%),
        radial-gradient(760px 520px at 90% 20%, rgba(15,23,42,.05), transparent 60%),
        linear-gradient(180deg, var(--bg), #f7f8fb);
      min-height:100vh;
      -webkit-font-smoothing:antialiased;

      display:flex;
      flex-direction:column;
    }

    a{color:inherit;text-decoration:none}
    .wrap{max-width:var(--container-max);margin:0 auto; width:100%}

    /* âœ… Ù†ÙØ³ Topbar Ø¨ØªØ§Ø¹ index */
    .topbar{
      position:sticky; top:0; z-index:30;
      display:flex; gap:12px; align-items:center; justify-content:space-between;
      padding:14px 16px;
      background: linear-gradient(180deg, rgba(255,255,255,.92), rgba(255,255,255,.70));
      border-bottom:1px solid var(--stroke);
      backdrop-filter: blur(10px);
    }
    .brand{display:flex; align-items:center; gap:12px}
    .logo{
      width:44px; height:44px; border-radius:999px; display:grid; place-items:center;
      background: linear-gradient(135deg, rgba(212,175,55,.18), rgba(184,134,11,.12));
      border:1px solid rgba(212,175,55,.35);
      box-shadow: 0 10px 26px rgba(15,23,42,.10);
      overflow:hidden; padding:6px;
      flex:0 0 auto;
    }
    .logo img{ width:100%; height:100%; object-fit:contain; display:block; }
    .brand-title{font-size:16px;font-weight:1000; letter-spacing:.2px}
    .brand-sub{font-size:12px;color:var(--muted)}

    .actions{
      display:flex; gap:10px; align-items:center;
      flex-wrap:wrap; justify-content:flex-end;
    }

    .back{
      padding:10px 12px;border-radius:14px;
      border:1px solid var(--stroke);
      background:rgba(255,255,255,.92);
      display:inline-flex;align-items:center;gap:8px;
      font-weight:1000;
      box-shadow: 0 8px 18px rgba(15,23,42,.06);
    }

    /* âœ… Layout padding */
    main{ padding:18px; }
    @media (max-width:720px){
      main{ padding:12px; }
      .topbar{ flex-direction:column; align-items:stretch; gap:10px; }
      .actions{ justify-content:stretch; }
      .back{ width:100%; justify-content:center; }
    }

    .card{
      margin-top:14px;padding:14px;
      border:1px solid var(--stroke);
      border-radius:var(--radius);
      background: linear-gradient(180deg, rgba(255,255,255,.96), rgba(255,255,255,.90));
      box-shadow: var(--shadow);
    }

    .invBar{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      justify-content:space-between;
      margin-top:10px;
      padding:10px;
      border:1px solid var(--stroke);
      border-radius:16px;
      background: rgba(248,250,252,.90);
      box-shadow: 0 8px 18px rgba(15,23,42,.06);
    }
    .invBar .k{color:var(--muted);font-weight:900;font-size:12px}
    .invBar .v{font-weight:1000}

    .copyBtn{
      padding:10px 12px;
      border-radius:14px;
      border:1px solid rgba(212,175,55,.55);
      background: linear-gradient(135deg, rgba(212,175,55,.22), rgba(184,134,11,.18));
      color:#0f172a;
      font-weight:1000;
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      gap:8px;
      user-select:none;
      white-space:nowrap;
      box-shadow: 0 12px 22px rgba(212,175,55,.14);
    }
    .copyBtn:active{transform: translateY(1px)}

    .note{
      margin-top:12px;padding:12px;border-radius:16px;
      border:1px solid rgba(212,175,55,.35);
      background: rgba(212,175,55,.10);
      color:#0f172a;
      font-weight:900;line-height:1.7;
    }

    .seg{
      display:flex;gap:14px;flex-wrap:wrap;
      padding:10px;border-radius:14px;
      border:1px solid var(--stroke);
      background: rgba(248,250,252,.90);
      margin-top:10px;
      box-shadow: 0 8px 18px rgba(15,23,42,.05);
    }
    .seg label{
      display:flex;
      align-items:center;
      gap:10px;
      margin:0;
      padding:10px 12px;
      border-radius:14px;
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.95);
      cursor:pointer;
      font-weight:1000;
      user-select:none;
    }
    .seg input{width:auto; margin:0}

    label{display:block;font-size:12px;color:var(--muted);margin:10px 0 6px;font-weight:900}

    input, select, textarea{
      width:100%;padding:12px;border-radius:14px;
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.95);
      color:var(--text);
      outline:none;font-size:14px;
      box-shadow: 0 8px 18px rgba(15,23,42,.06);
    }
    input:focus, select:focus, textarea:focus{
      border-color: rgba(212,175,55,.65);
      box-shadow: 0 10px 22px rgba(212,175,55,.14);
    }
    @media (max-width:720px){
      input, textarea, select{ font-size:16px; } /* iOS zoom fix */
    }

    /* âœ… Errors */
    .fieldError{
      margin-top:6px;
      font-size:12px;
      color:#991b1b;
      font-weight:1000;
      display:none;
    }
    .invalid{
      border-color: rgba(220,38,38,.70) !important;
      box-shadow: 0 0 0 3px rgba(220,38,38,.14) !important;
    }
    @keyframes shakeX{
      0%{transform:translateX(0)}
      20%{transform:translateX(-6px)}
      40%{transform:translateX(6px)}
      60%{transform:translateX(-4px)}
      80%{transform:translateX(4px)}
      100%{transform:translateX(0)}
    }
    .shake{ animation: shakeX .28s ease; }

    .row2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media(max-width:720px){.row2{grid-template-columns:1fr}}

    .items{
      display:flex; flex-direction:column; gap:10px;
      margin-top:10px;
    }
    .item{
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.92);
      border-radius:16px;
      padding:10px;
      display:flex; gap:10px; align-items:center;
      justify-content:space-between;
      flex-wrap:wrap;
      box-shadow: 0 10px 22px rgba(15,23,42,.08);
    }
    .thumb{
      width:56px;height:56px;border-radius:14px;
      border:1px solid var(--stroke);
      object-fit:cover;background: rgba(241,245,249,.9);
      flex:0 0 auto;
    }
    .iInfo{flex:1; min-width:0}
    .iName{font-weight:1000; font-size:13px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis}
    .iMeta{font-size:11px;color:var(--muted); margin-top:3px; font-weight:900}
    .status{font-weight:1000}
    .st-available{color:var(--ok)}
    .st-low{color:var(--warn)}
    .st-out{color:var(--bad)}
    .st-unknown{color:#334155}

    .qtyBox{display:flex; align-items:center; gap:6px}
    .qBtn{
      width:42px;height:42px;border-radius:12px;
      border:1px solid var(--stroke);
      background:rgba(255,255,255,.95);
      color:var(--text);
      cursor:pointer;font-weight:1000;
      display:inline-flex;align-items:center;justify-content:center;
      touch-action: manipulation;
    }
    .qVal{
      min-width:48px;text-align:center;
      border:1px solid var(--stroke);
      background:rgba(255,255,255,.95);
      border-radius:12px;
      padding:8px 8px;
      font-weight:1000;font-size:14px;
    }
    .rmBtn{
      margin-top:6px;
      font-size:13px;
      color:#b91c1c;
      cursor:pointer;
      user-select:none;
      background:transparent;border:none;
      font-weight:1000;
      touch-action: manipulation;
    }

    .btns{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
    button{
      cursor:pointer;border-radius:16px;padding:12px 14px;
      font-weight:1000;border:1px solid var(--stroke);
      background:rgba(255,255,255,.95);
      color:var(--text);
      flex:1;
      transition: opacity .15s ease, transform .15s ease, box-shadow .15s ease;
      touch-action: manipulation;
      box-shadow: 0 10px 22px rgba(15,23,42,.06);
    }
    button:active{transform: translateY(1px)}
    button:disabled{
      opacity:.45;
      cursor:not-allowed;
      transform:none;
      filter:saturate(.85);
    }

    .primary{
      border-color: rgba(212,175,55,.65);
      background: linear-gradient(135deg, rgba(212,175,55,.28), rgba(184,134,11,.22));
      box-shadow: 0 12px 22px rgba(212,175,55,.14);
    }

    .success{
      margin-top:12px;padding:12px;border-radius:16px;
      border:1px solid rgba(22,163,74,.22);
      background:rgba(22,163,74,.08);
      color:#0f172a;font-weight:1000;line-height:1.7;
      display:none;
    }
    .empty{
      padding:14px;
      border:1px dashed var(--stroke);
      border-radius: var(--radius);
      color:var(--muted);
      text-align:center;
      background: rgba(255,255,255,.85);
    }

    .toast{
      position:fixed; bottom:16px; left:16px;
      padding:10px 12px;border-radius:12px;border:1px solid var(--stroke);
      background:rgba(15,23,42,.88); color:#fff; z-index:999;
      display:none; font-weight:1000;
      max-width:min(92vw, 520px);
    }

    /* âœ… Mobile fixed action bar */
    .actionBar{
      position:fixed;
      left:0; right:0;
      bottom:0;
      padding:10px 12px calc(10px + var(--safe-b));
      background: linear-gradient(180deg, rgba(255,255,255,.75), rgba(255,255,255,.96));
      border-top:1px solid var(--stroke);
      backdrop-filter: blur(12px);
      z-index:1000;
      display:none;
    }
    .actionBar .inner{
      max-width:var(--container-max);
      margin:0 auto;
      display:flex;
      gap:10px;
      align-items:stretch;
    }
    .actionBar .inner button{ flex:1; padding:14px 14px; border-radius:18px; }

    /* show action bar only on mobile */
    @media (max-width:720px){
      body{ padding-bottom: calc(12px + var(--bar-h) + var(--safe-b)); }
      .actionBar{ display:block; }
      .btns{ display:none; } /* prevent duplicate buttons */
    }

    :focus{ outline:3px solid rgba(212,175,55,.25); outline-offset:3px; }

    .site-footer{
      margin-top:auto;
      padding:16px 16px 22px;
      text-align:center;
      color:var(--muted);
      border-top:1px solid var(--stroke);
      background: rgba(255,255,255,.78);
      backdrop-filter: blur(10px);
      padding-bottom: calc(22px + env(safe-area-inset-bottom));
    }
    .site-footer .line1{ font-weight:1000; color:#0f172a; }
    .site-footer .line2{ margin-top:6px; font-weight:900; }
  </style>
</head>

<body>
  <!-- âœ… Header with logo (Ø²ÙŠ index) -->
  <header class="topbar">
    <div class="brand">
      <div class="logo">
        <img id="siteLogo" src="images/bslogo.webp" alt="BS Logo"
          onerror="this.onerror=null;this.style.display='none';this.parentElement.textContent='BS'">
      </div>
      <div>
        <div class="brand-title">B.S Medical &amp; Aesthetic</div>
        <div class="brand-sub">Ø±Ø§Ø¬Ø¹ Ø§Ù„Ø³Ù„Ø© Ø«Ù… Ø£Ø±Ø³Ù„ Ø§Ù„Ø·Ù„Ø¨</div>
      </div>
    </div>

    <div class="actions">
      <a class="back" href="./" aria-label="Ø±Ø¬ÙˆØ¹ Ù„Ù„ÙƒØªØ§Ù„ÙˆØ¬">â† Ø±Ø¬ÙˆØ¹ Ù„Ù„ÙƒØªØ§Ù„ÙˆØ¬</a>
    </div>
  </header>

  <main>
    <div class="wrap">
      <div class="card" aria-live="polite">
        <div style="font-weight:1000">Ù…Ø­ØªÙˆÙŠØ§Øª Ø§Ù„Ø³Ù„Ø©</div>

        <div class="invBar" aria-label="Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø·Ù„Ø¨">
          <div>
            <div class="k">Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨</div>
            <div class="v" id="orderIdView">â€”</div>
          </div>
          <button class="copyBtn" id="copyOrderId" type="button" aria-label="Ù†Ø³Ø® Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨">ğŸ“‹ Ù†Ø³Ø®</button>
        </div>

        <div id="cartBox" class="items"></div>

        <div class="note" id="note" role="status"></div>

        <div style="margin-top:10px;font-weight:1000">Ù†ÙˆØ¹ Ø§Ù„Ø·Ù„Ø¨</div>
        <div class="seg">
          <label><input type="radio" name="type" value="Ù‚Ø·Ø§Ø¹ÙŠ" checked> Ù‚Ø·Ø§Ø¹ÙŠ</label>
          <label><input type="radio" name="type" value="Ø¬Ù…Ù„Ø©"> Ø¬Ù…Ù„Ø©</label>
        </div>
      </div>

      <div class="card">
        <div style="font-weight:1000;margin-bottom:8px">Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„</div>

        <div class="row2">
          <div>
            <label for="name">Ø§Ù„Ø§Ø³Ù…</label>
            <input id="name" placeholder="Ø§ÙƒØªØ¨ Ø§Ø³Ù…Ùƒ" autocomplete="name" />
            <div class="fieldError" id="err_name">âš ï¸ Ù…Ù† ÙØ¶Ù„Ùƒ Ø§ÙƒØªØ¨ Ø§Ù„Ø§Ø³Ù…</div>
          </div>
          <div>
            <label for="phone">Ø±Ù‚Ù… Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„</label>
            <input id="phone" placeholder="Ù…Ø«Ø§Ù„: 01xxxxxxxxx Ø£Ùˆ +201xxxxxxxxx" inputmode="tel" autocomplete="tel" />
            <div class="fieldError" id="err_phone">âš ï¸ Ù…Ù† ÙØ¶Ù„Ùƒ Ø§ÙƒØªØ¨ Ø±Ù‚Ù… Ù…ÙˆØ¨Ø§ÙŠÙ„ ØµØ­ÙŠØ­</div>
          </div>
        </div>

        <label for="address">Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</label>
        <textarea id="address" placeholder="Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø© / Ø§Ù„Ù…Ù†Ø·Ù‚Ø© / ØªÙØ§ØµÙŠÙ„" rows="2" autocomplete="street-address"></textarea>
        <div class="fieldError" id="err_address">âš ï¸ Ù…Ù† ÙØ¶Ù„Ùƒ Ø§ÙƒØªØ¨ Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</div>

        <div class="btns">
          <button class="primary" id="sendOrder">Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨ (ÙˆØ§ØªØ³Ø§Ø¨)</button>
          <button id="clear" type="button">ØªÙØ±ÙŠØº Ø§Ù„Ø³Ù„Ø©</button>
        </div>

        <div id="ok" class="success" role="status"></div>
      </div>
    </div>
  </main>

  <!-- âœ… Ø´Ø±ÙŠØ· Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„ Ø§Ù„Ø«Ø§Ø¨Øª -->
  <div class="actionBar" role="region" aria-label="Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø§Ù„Ø·Ù„Ø¨">
    <div class="inner">
      <button class="primary" id="sendOrderMobile" type="button">Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨ (ÙˆØ§ØªØ³Ø§Ø¨)</button>
      <button id="clearMobile" type="button">ØªÙØ±ÙŠØº</button>
    </div>
  </div>

  <div id="toast" class="toast" role="status" aria-live="polite"></div>

  <footer class="site-footer">
    <div class="line1">Axentro â€“ All Rights Reserved 2024 Â©</div>
    <div class="line2">By Ahmed Hamouda</div>
  </footer>

<script>
  /* ====== Ø¨ÙŠØ§Ù†Ø§ØªÙƒ ====== */
  const OWNER_WA = "201146476993";
  const API_URL  = "https://script.google.com/macros/s/AKfycbwsPPw3UiW6TBngBcbFxY4E8rB7JYgK1W2LRn0WaS9C7OitA1FgZ1vAz9Qr1u_ojlZ8/exec";

  const LS_KEY   = "AX_CART_V1";
  const cartBox  = document.getElementById("cartBox");
  const note     = document.getElementById("note");
  const ok       = document.getElementById("ok");

  const sendBtnDesktop = document.getElementById("sendOrder");
  const sendBtnMobile  = document.getElementById("sendOrderMobile");
  const clearDesktop   = document.getElementById("clear");
  const clearMobile    = document.getElementById("clearMobile");

  const toastEl  = document.getElementById("toast");

  const orderIdView = document.getElementById("orderIdView");
  const copyOrderId = document.getElementById("copyOrderId");

  // âœ… Inputs
  const nameEl    = document.getElementById("name");
  const phoneEl   = document.getElementById("phone");
  const addressEl = document.getElementById("address");

  // âœ… Error helpers
  const errName    = document.getElementById("err_name");
  const errPhone   = document.getElementById("err_phone");
  const errAddress = document.getElementById("err_address");

  const IMG_PLACEHOLDER = "https://via.placeholder.com/600x400?text=No+Image";

  function resolveImageById(id){
    return `images/${id}.webp`;
  }

  const PROD_CACHE_KEY = "AX_PRODUCTS_CACHE_V1";
  const PROD_CACHE_TS  = "AX_PRODUCTS_CACHE_TS_V1";
  const CACHE_TTL_MS   = 10 * 60 * 1000;

  let products = [];

  function escapeHtml(s){
    return String(s||"")
      .replace(/&/g,"&amp;")
      .replace(/</g,"&lt;")
      .replace(/>/g,"&gt;")
      .replace(/"/g,"&quot;");
  }
  function escapeAttr(s){
    return String(s||"").replace(/"/g,"&quot;");
  }

  function statusClass(av){
    if(av === "Low stock") return "st-low";
    if(av === "Out of stock") return "st-out";
    if(av === "Available") return "st-available";
    return "st-unknown";
  }

  function getType(){
    return document.querySelector("input[name='type']:checked").value;
  }

  function setNote(){
    note.textContent =
      getType()==="Ø¬Ù…Ù„Ø©"
      ? "âœ… ØªÙ… Ø§Ø³ØªÙ„Ø§Ù… Ø·Ù„Ø¨ Ø§Ù„Ø¬Ù…Ù„Ø©. Ø³ÙŠØªÙ… Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ø·Ù„Ø¨ ÙˆØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ ÙˆØ§Ù„ØªÙˆØ§ØµÙ„ Ù…Ø¹Ùƒ."
      : "âœ… ØªÙ… Ø§Ø³ØªÙ„Ø§Ù… Ø·Ù„Ø¨Ùƒ Ø¨Ù†Ø¬Ø§Ø­. Ø³ÙŠØªÙ… Ø§Ù„ØªÙˆØ§ØµÙ„ Ù…Ø¹Ùƒ Ù„ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø·Ù„Ø¨ ÙˆØ¥Ø±Ø³Ø§Ù„ Ø§Ù„ÙØ§ØªÙˆØ±Ø©.";
  }

  function showToast(msg){
    toastEl.textContent = msg;
    toastEl.style.display = "block";
    clearTimeout(showToast._t);
    showToast._t = setTimeout(()=> toastEl.style.display="none", 2200);
  }

  function getCart(){
    try{
      const raw = localStorage.getItem(LS_KEY);
      return raw ? JSON.parse(raw) : [];
    }catch(e){ return []; }
  }

  function setCart(items){
    localStorage.setItem(LS_KEY, JSON.stringify(items));
  }

  function ensureCartInitialized(){
    if(localStorage.getItem(LS_KEY) === null){
      setCart([]);
    }
  }

  /* âœ… ØªØ¹Ø¯ÙŠÙ„: Ù†Ø³Ù…Ø­ Ø¨Ø§Ù„ØµÙØ± => ÙŠØªØ´Ø§Ù„ ØªÙ„Ù‚Ø§Ø¦ÙŠ */
  function setQty(pid, qty){
    const cart = getCart();
    const idx = cart.findIndex(x=>String(x.id)===String(pid));
    if(idx<0) return;

    const q = Math.max(0, Number(qty)||0);
    if(q === 0){
      cart.splice(idx, 1);
      setCart(cart);
      renderCart();
      showToast("ØªÙ… Ø­Ø°Ù Ø§Ù„ØµÙ†Ù");
      return;
    }

    cart[idx].qty = q;
    setCart(cart);
    renderCart();
  }

  function removeItem(pid){
    setCart(getCart().filter(x=>String(x.id)!==String(pid)));
    renderCart();
    showToast("ØªÙ… Ø­Ø°Ù Ø§Ù„ØµÙ†Ù");
  }

  function findProduct(pid){
    return products.find(x=>String(x.id)===String(pid)) || null;
  }

  function updateSendButtonsState(){
    const hasItems = getCart().length > 0;
    const disabled = !hasItems;
    if(sendBtnDesktop){ sendBtnDesktop.disabled = disabled; }
    if(sendBtnMobile){ sendBtnMobile.disabled = disabled; }
  }

  function renderCart(){
    const cart = getCart();
    cartBox.innerHTML = "";

    if(cart.length === 0){
      cartBox.innerHTML = `<div class="empty">Ø§Ù„Ø³Ù„Ø© ÙØ§Ø±ØºØ©. Ø§Ø±Ø¬Ø¹ Ù„Ù„ÙƒØªØ§Ù„ÙˆØ¬ ÙˆØ£Ø¶Ù Ù…Ù†ØªØ¬Ø§Øª.</div>`;
      updateSendButtonsState();
      return;
    }

    cart.forEach(it=>{
      const p = findProduct(it.id);

      const safe = p || {
        id: it.id,
        name: "Ù…Ù†ØªØ¬ ØºÙŠØ± Ù…ØªØ§Ø­ (ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙƒØªØ§Ù„ÙˆØ¬)",
        category: "â€”",
        availability: "Unknown"
      };

      const row = document.createElement("div");
      row.className = "item";

      row.innerHTML = `
        <div style="display:flex;align-items:center;gap:12px;flex:1;min-width:0">
          <img class="thumb" loading="lazy" decoding="async"
            src="${resolveImageById(escapeAttr(safe.id))}"
            onerror="this.onerror=null;this.src='${IMG_PLACEHOLDER}'"
            alt="${escapeHtml(safe.name)}">
          <div class="iInfo">
            <div class="iName">${escapeHtml(safe.name)}</div>
            <div class="iMeta">
              ${escapeHtml(safe.category)} â€¢
              <span class="status ${statusClass(safe.availability)}">${escapeHtml(safe.availability)}</span> â€¢
              ${escapeHtml(safe.id)}
            </div>
          </div>
        </div>

        <div style="display:flex;align-items:center;gap:12px;">
          <div class="qtyBox" aria-label="ÙƒÙ…ÙŠØ© Ø§Ù„Ù…Ù†ØªØ¬">
            <button class="qBtn" data-act="minus" data-id="${escapeAttr(safe.id)}" aria-label="Ø¥Ù†Ù‚Ø§Øµ">âˆ’</button>
            <div class="qVal" aria-live="polite">${Number(it.qty)||1}</div>
            <button class="qBtn" data-act="plus" data-id="${escapeAttr(safe.id)}" aria-label="Ø²ÙŠØ§Ø¯Ø©">+</button>
          </div>
          <button class="rmBtn" data-act="rm" data-id="${escapeAttr(safe.id)}" aria-label="Ø­Ø°Ù Ù…Ù† Ø§Ù„Ø³Ù„Ø©">Ø­Ø°Ù</button>
        </div>
      `;

      cartBox.appendChild(row);
    });

    updateSendButtonsState();
  }

  cartBox.addEventListener("click", (ev)=>{
    const btn = ev.target.closest("[data-act]");
    if(!btn) return;

    const act = btn.getAttribute("data-act");
    const id  = btn.getAttribute("data-id");
    if(!id) return;

    if(act === "rm"){ removeItem(id); return; }

    const cart = getCart();
    const it = cart.find(x=>String(x.id)===String(id));
    const current = Number(it?.qty)||0;

    if(act === "plus"){ setQty(id, current + 1); return; }
    if(act === "minus"){ setQty(id, Math.max(0, current - 1)); return; }
  });

  cartBox.addEventListener("keydown", (ev)=>{
    const btn = ev.target.closest("[data-act]");
    if(!btn) return;
    if(ev.key !== "Enter" && ev.key !== " ") return;
    ev.preventDefault();
    btn.click();
  });

  function formatDateOnly(d){
    const dd = String(d.getDate()).padStart(2,"0");
    const mm = String(d.getMonth()+1).padStart(2,"0");
    const yyyy = d.getFullYear();
    return `${dd}-${mm}-${yyyy}`;
  }

  function formatTimeOnly12(d){
    let h = d.getHours();
    const min = String(d.getMinutes()).padStart(2,"0");
    const ampm = h >= 12 ? "PM" : "AM";
    h = h % 12; if(h === 0) h = 12;
    const hh = String(h).padStart(2,"0");
    return `${hh}:${min} ${ampm}`;
  }

  function generateOrderId(){
    const d = new Date();
    const y = d.getFullYear();
    const m = String(d.getMonth()+1).padStart(2,"0");
    const day = String(d.getDate()).padStart(2,"0");
    const rnd = Math.floor(100 + Math.random()*900);
    return `BS-${y}${m}${day}-${rnd}`;
  }

  function getStableOrderId(){
    let id = sessionStorage.getItem("BS_ORDER_ID");
    if(!id){
      id = generateOrderId();
      sessionStorage.setItem("BS_ORDER_ID", id);
    }
    return id;
  }

  function refreshOrderIdUI(){
    const id = getStableOrderId();
    orderIdView.textContent = id;
  }

  copyOrderId.addEventListener("click", async ()=>{
    const id = getStableOrderId();
    try{
      await navigator.clipboard.writeText(id);
      showToast("âœ… ØªÙ… Ù†Ø³Ø® Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨");
    }catch(e){
      const ta = document.createElement("textarea");
      ta.value = id;
      ta.style.position = "fixed";
      ta.style.left = "-9999px";
      document.body.appendChild(ta);
      ta.select();
      document.execCommand("copy");
      document.body.removeChild(ta);
      showToast("âœ… ØªÙ… Ù†Ø³Ø® Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨");
    }
  });

  /* Validation */
  function clearFieldError(el, errEl){
    if(!el) return;
    el.classList.remove("invalid","shake");
    if(errEl) errEl.style.display = "none";
  }

  function setFieldError(el, errEl, msg){
    if(!el) return;
    el.classList.add("invalid","shake");
    setTimeout(()=> el.classList.remove("shake"), 320);

    if(errEl){
      errEl.textContent = msg || errEl.textContent;
      errEl.style.display = "block";
    }

    try{ el.focus({preventScroll:true}); }catch(e){ try{ el.focus(); }catch(_){ } }
    try{ el.scrollIntoView({behavior:"smooth", block:"center"}); }catch(e){ }
  }

  ["input","change","blur"].forEach(evt=>{
    nameEl?.addEventListener(evt, ()=> clearFieldError(nameEl, errName));
    phoneEl?.addEventListener(evt, ()=> clearFieldError(phoneEl, errPhone));
    addressEl?.addEventListener(evt, ()=> clearFieldError(addressEl, errAddress));
  });

  function validateAndMark(){
    const cart = getCart();
    if(!cart.length) return { ok:false, msg:"Ø§Ù„Ø³Ù„Ø© ÙØ§Ø±ØºØ©." };

    clearFieldError(nameEl, errName);
    clearFieldError(phoneEl, errPhone);
    clearFieldError(addressEl, errAddress);

    const name = (nameEl.value||"").trim();
    const phone = (phoneEl.value||"").trim();
    const address = (addressEl.value||"").trim();

    if(!name){
      setFieldError(nameEl, errName, "âš ï¸ Ù…Ù† ÙØ¶Ù„Ùƒ Ø§ÙƒØªØ¨ Ø§Ù„Ø§Ø³Ù…");
      return { ok:false, msg:"Ù„Ø§Ø²Ù… ØªØ¯Ø®Ù„ Ø§Ù„Ø§Ø³Ù…." };
    }

    if(!phone){
      setFieldError(phoneEl, errPhone, "âš ï¸ Ù…Ù† ÙØ¶Ù„Ùƒ Ø§ÙƒØªØ¨ Ø±Ù‚Ù… Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„");
      return { ok:false, msg:"Ù„Ø§Ø²Ù… ØªØ¯Ø®Ù„ Ø±Ù‚Ù… Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„." };
    }

    const p = phone.replace(/\s+/g,"");
    const okPhone = /^01\d{9}$/.test(p) || /^(\+?20)1\d{9}$/.test(p);
    if(!okPhone){
      setFieldError(phoneEl, errPhone, "âš ï¸ Ø±Ù‚Ù… Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„ ØºÙŠØ± ØµØ­ÙŠØ­ (Ù…Ø«Ø§Ù„: 01xxxxxxxxx Ø£Ùˆ +201xxxxxxxxx)");
      return { ok:false, msg:"Ø±Ù‚Ù… Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„ ØºÙŠØ± ØµØ­ÙŠØ­." };
    }

    if(!address){
      setFieldError(addressEl, errAddress, "âš ï¸ Ù…Ù† ÙØ¶Ù„Ùƒ Ø§ÙƒØªØ¨ Ø§Ù„Ø¹Ù†ÙˆØ§Ù†");
      return { ok:false, msg:"Ù„Ø§Ø²Ù… ØªØ¯Ø®Ù„ Ø§Ù„Ø¹Ù†ÙˆØ§Ù†." };
    }

    const hasOut = cart.some(it=>{
      const pr = findProduct(it.id);
      return pr && pr.availability === "Out of stock";
    });
    if(hasOut){
      return { ok:false, msg:"ÙÙŠÙ‡ ØµÙ†Ù ØºÙŠØ± Ù…ØªØ§Ø­ Ø¯Ø§Ø®Ù„ Ø§Ù„Ø³Ù„Ø©. Ø§Ø­Ø°ÙÙ‡ Ø£ÙˆÙ„Ø§Ù‹." };
    }

    return { ok:true, msg:"" };
  }

  function buildMsg(){
    const cart = getCart();
    const orderId = getStableOrderId();
    const type = getType();

    const name = (nameEl.value||"").trim();
    const phone = (phoneEl.value||"").trim();
    const address = (addressEl.value||"").trim();

    const now = new Date();
    const dOnly = formatDateOnly(now);
    const tOnly = formatTimeOnly12(now);

    let totalQty = 0;

    const lines = [];
    lines.push("ğŸ§¾ Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯ â€” B.S Medical & Aesthetic");
    lines.push("â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”");
    lines.push("");
    lines.push("ğŸ”– Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨:");
    lines.push(orderId);
    lines.push("");
    lines.push("ğŸ“… Ø§Ù„ØªØ§Ø±ÙŠØ®:");
    lines.push(dOnly);
    lines.push("");
    lines.push("â° Ø§Ù„ÙˆÙ‚Øª:");
    lines.push(tOnly);
    lines.push("");
    lines.push("ğŸ“¦ Ù†ÙˆØ¹ Ø§Ù„Ø·Ù„Ø¨:");
    lines.push(type);
    lines.push("");
    lines.push("â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”");
    lines.push("ğŸ“‹ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø£ØµÙ†Ø§Ù:");

    cart.forEach((it)=>{
      const pr = findProduct(it.id);
      const safeName = pr?.name ? String(pr.name).trim() : "Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬";
      const qty = Number(it.qty)||1;
      totalQty += qty;
      lines.push(`â€¢ ${it.id} | ${safeName} | Ø§Ù„ÙƒÙ…ÙŠØ©: ${qty}`);
    });

    lines.push("");
    lines.push("ğŸ”¢ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù‚Ø·Ø¹:");
    lines.push(String(totalQty));
    lines.push("");
    lines.push("â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”");
    lines.push("ğŸ‘¤ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„:");
    lines.push(`Ø§Ù„Ø§Ø³Ù…: ${name}`);
    lines.push(`ğŸ“ ${phone}`);
    lines.push(`ğŸ“ ${address}`);
    lines.push("");
    lines.push("â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”");

    if(type === "Ø¬Ù…Ù„Ø©"){
      lines.push("âœ… ØªÙ… Ø§Ø³ØªÙ„Ø§Ù… Ø·Ù„Ø¨ Ø§Ù„Ø¬Ù…Ù„Ø© Ø¨Ù†Ø¬Ø§Ø­");
      lines.push("Ø³ÙŠØªÙ… Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ø·Ù„Ø¨ ÙˆØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ");
      lines.push("ÙˆØ§Ù„ØªÙˆØ§ØµÙ„ Ù…Ø¹ÙƒÙ… ÙÙŠ Ø£Ù‚Ø±Ø¨ ÙˆÙ‚Øª.");
    }else{
      lines.push("âœ… ØªÙ… Ø§Ø³ØªÙ„Ø§Ù… Ø§Ù„Ø·Ù„Ø¨ Ø¨Ù†Ø¬Ø§Ø­");
      lines.push("Ø³ÙŠØªÙ… Ø§Ù„ØªÙˆØ§ØµÙ„ Ù…Ø¹ÙƒÙ… Ù„ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø·Ù„Ø¨");
      lines.push("ÙˆØ¥Ø±Ø³Ø§Ù„ Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©.");
    }

    return lines.join("\n");
  }

  function saveProductsCache(list){
    localStorage.setItem(PROD_CACHE_KEY, JSON.stringify(list));
    localStorage.setItem(PROD_CACHE_TS, String(Date.now()));
  }

  function loadProductsFromCache(){
    try{
      const raw = localStorage.getItem(PROD_CACHE_KEY);
      const ts = Number(localStorage.getItem(PROD_CACHE_TS) || 0);
      if(!raw) return null;
      const list = JSON.parse(raw);
      if(!Array.isArray(list)) return null;
      return { list, ts };
    }catch(e){
      return null;
    }
  }

  async function fetchProductsFromApi(){
    const res = await fetch(API_URL, { cache: "no-store" });
    if(!res.ok) throw new Error("HTTP " + res.status);
    const data = await res.json();
    return Array.isArray(data) ? data : [];
  }

  async function hydrateProductsFast(){
    const cached = loadProductsFromCache();
    const now = Date.now();
    const hasCache = cached && cached.list && cached.list.length;

    if(hasCache){
      products = cached.list;
      renderCart();
    } else {
      products = [];
      renderCart();
      if(getCart().length){
        cartBox.insertAdjacentHTML("afterbegin", `<div class="empty" style="margin-bottom:10px">Ø¬Ø§Ø±Ù ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª...</div>`);
      }
    }

    const cacheFresh = hasCache && (now - cached.ts) < CACHE_TTL_MS;

    const doFetch = async () => {
      try{
        const freshList = await fetchProductsFromApi();
        products = freshList;
        saveProductsCache(freshList);
        renderCart();
      }catch(err){
        console.error(err);
        if(!hasCache && getCart().length){
          note.textContent = "âš ï¸ Ù…Ù„Ø§Ø­Ø¸Ø©: Ù„Ù… ÙŠØªÙ… ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ù…Ù† Ø§Ù„Ø´ÙŠØª Ø§Ù„Ø¢Ù†. ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨ØŒ Ù„ÙƒÙ† Ø¨Ø¹Ø¶ Ø£Ø³Ù…Ø§Ø¡/Ø­Ø§Ù„Ø§Øª Ø§Ù„Ø£ØµÙ†Ø§Ù Ù‚Ø¯ Ù„Ø§ ØªÙƒÙˆÙ† Ù…Ø­Ø¯Ø«Ø©.";
        } else {
          showToast("ØªØ¹Ø°Ø± ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙƒØªØ§Ù„ÙˆØ¬ØŒ ÙŠØªÙ… Ø¹Ø±Ø¶ Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ù…Ø®Ø²Ù†Ø© Ø¥Ù† ÙˆÙØ¬Ø¯Øª.");
        }
      }
    };

    if(cacheFresh){
      setTimeout(doFetch, 400);
    } else {
      await doFetch();
    }
  }

  function clearCartAll(){
    setCart([]);
    renderCart();
    ok.style.display="none";
    sessionStorage.removeItem("BS_ORDER_ID");
    refreshOrderIdUI();
    showToast("ØªÙ… ØªÙØ±ÙŠØº Ø§Ù„Ø³Ù„Ø©");
  }

  async function sendOrderFlow(btnRef){
    const v = validateAndMark();
    if(!v.ok){
      showToast(v.msg);
      return;
    }

    const oldText = btnRef.textContent;
    btnRef.disabled = true;
    btnRef.textContent = "Ø¬Ø§Ø±Ù ÙØªØ­ ÙˆØ§ØªØ³Ø§Ø¨...";

    const msg = buildMsg();
    const waUrl = `https://wa.me/${OWNER_WA}?text=${encodeURIComponent(msg)}`;
    window.open(waUrl, "_blank");

    ok.style.display="block";
    ok.textContent =
      (getType()==="Ø¬Ù…Ù„Ø©")
      ? "âœ… ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨ Ø§Ù„Ø¬Ù…Ù„Ø© Ø¨Ù†Ø¬Ø§Ø­. Ø³ÙŠØªÙ… Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ø·Ù„Ø¨ ÙˆØ§Ù„ØªÙˆØ§ØµÙ„ Ù…Ø¹Ùƒ."
      : "âœ… ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨ Ø¨Ù†Ø¬Ø§Ø­. Ø³ÙŠØªÙ… Ø§Ù„ØªÙˆØ§ØµÙ„ Ù„ØªØ£ÙƒÙŠØ¯Ù‡ ÙˆØ¥Ø±Ø³Ø§Ù„ Ø§Ù„ÙØ§ØªÙˆØ±Ø©.";

    setCart([]);
    renderCart();
    sessionStorage.removeItem("BS_ORDER_ID");
    refreshOrderIdUI();

    setTimeout(()=>{
      btnRef.disabled = false;
      btnRef.textContent = oldText;
      window.location.href = "./";
    }, 1200);
  }

  document.querySelectorAll("input[name='type']").forEach(r=> r.addEventListener("change", setNote));
  setNote();

  clearDesktop?.addEventListener("click", clearCartAll);
  clearMobile?.addEventListener("click", clearCartAll);

  sendBtnDesktop?.addEventListener("click", ()=> sendOrderFlow(sendBtnDesktop));
  sendBtnMobile?.addEventListener("click", ()=> sendOrderFlow(sendBtnMobile));

  // Init
  ensureCartInitialized();
  refreshOrderIdUI();
  hydrateProductsFast();
  renderCart();
</script>
</body>
</html>
