<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>B.S Medical &amp; Aesthetic â€” ÙƒØªØ§Ù„ÙˆØ¬ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</title>
  <style>
  :root{
    --bg1:#0b1020; --bg2:#0f172a;
    --stroke:#ffffff1a; --text:#e5e7eb; --muted:#94a3b8;
    --shadow: 0 18px 50px rgba(0,0,0,.45);
    --radius:18px;
    --accent:#60a5fa; --accent2:#a78bfa;
    --ok:#22c55e; --warn:#facc15; --bad:#ef4444;
  }

  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;
    font-family: system-ui, -apple-system, "Segoe UI", Tahoma, Arial;
    color:var(--text);
    background:
      radial-gradient(900px 500px at 10% 10%, rgba(96,165,250,.25), transparent 55%),
      radial-gradient(700px 500px at 90% 20%, rgba(167,139,250,.18), transparent 55%),
      linear-gradient(180deg, var(--bg1), var(--bg2));
    min-height:100vh;
    -webkit-font-smoothing:antialiased;

    /* âœ… Ø¹Ù„Ø´Ø§Ù† Ø§Ù„ÙÙˆØªØ± ÙŠØ«Ø¨Øª ØªØ­Øª */
    display:flex;
    flex-direction:column;
  }
  a{color:inherit;text-decoration:none}

  /* âœ… Ù„Ù…Ø³ Ø£Ù†Ø¹Ù… Ø¹Ù„Ù‰ Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„ */
  button{ -webkit-tap-highlight-color: transparent; touch-action: manipulation; }
  .qMiniBtn,.qBtn,.xBtn,.addBtn,.footBtn{ touch-action: manipulation; }

  .topbar{
    position:sticky; top:0; z-index:10;
    display:flex; gap:12px; align-items:center; justify-content:space-between;
    padding:14px 16px;
    background: linear-gradient(180deg, rgba(15,23,42,.92), rgba(15,23,42,.55));
    border-bottom:1px solid var(--stroke);
    backdrop-filter: blur(12px);
  }
  .brand{display:flex; align-items:center; gap:12px}
  .logo{
    width:44px; height:44px; border-radius:999px; display:grid; place-items:center;
    background: linear-gradient(135deg, rgba(96,165,250,.35), rgba(167,139,250,.25));
    border:1px solid var(--stroke); box-shadow: var(--shadow);
    overflow:hidden; padding:5px;
    flex:0 0 auto;
  }
  .logo img{ width:100%; height:100%; object-fit:contain; display:block; }
  .brand-title{font-size:16px;font-weight:900}
  .brand-sub{font-size:12px;color:var(--muted)}
  .actions{display:flex; gap:10px; align-items:center; flex-wrap:wrap; justify-content:flex-end}

  .input{
    width:220px; max-width:85vw; padding:12px;
    border-radius:14px; border:1px solid var(--stroke);
    background: rgba(255,255,255,.06); color:var(--text);
    outline:none; font-size:14px;
  }

  /* âœ… Ù…Ù†Ø¹ Zoom iOS + ØªØ­Ø³ÙŠÙ† Ø§Ù„ØªØ¬Ø±Ø¨Ø© */
  @media (max-width:720px){
    .input{ font-size:16px; }
  }

  /* âœ… Ø¹Ù„Ø´Ø§Ù† Ø§Ù„Ù…Ø­ØªÙˆÙ‰ ÙŠØ§Ø®Ø¯ Ø§Ù„Ù…Ø³Ø§Ø­Ø© ÙˆÙŠØ¯ÙØ¹ Ø§Ù„ÙÙˆØªØ± ØªØ­Øª */
  main.container{flex:1}

  /* âœ… (ØªØ¹Ø¯ÙŠÙ„ Ù…Ù‡Ù…) Ø§Ù„ÙƒÙˆÙ†ØªÙŠÙ†Ø± ÙŠØ³ØªØºÙ„ Ù…Ø³Ø§Ø­Ø© Ø§Ù„Ù„Ø§Ø¨ØªÙˆØ¨/Ø§Ù„Ø¯ÙŠØ³ÙƒØªÙˆØ¨ Ø¨Ø¯Ù„ Ù…Ø§ ÙŠØ¨Ù‚Ù‰ Ù…Ø­Ø¨ÙˆØ³ */
  .container{
    width: min(1400px, 96vw);
    margin:18px auto;
    padding:0 16px;
  }
  @media (min-width: 1400px){
    .container{ width: min(1600px, 92vw); }
  }

  /* âœ… GRID: ÙŠØ³ØªØºÙ„ Ø§Ù„Ø´Ø§Ø´Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø¯ÙŠØ³ÙƒØªÙˆØ¨ + ÙŠÙØ¶Ù„ Ø¬Ù…ÙŠÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„ */
  .grid{
    display:grid;
    gap:12px;
    grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
  }
  @media (min-width: 992px){
    .grid{
      gap:16px;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    }
  }

  .card{
    border-radius: var(--radius); overflow:hidden; border:1px solid var(--stroke);
    background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
    box-shadow: var(--shadow);
    transition: transform .18s ease, border-color .18s ease;
    display:flex; flex-direction:column; min-height:220px;
    will-change: transform;
  }
  .card:hover{transform: translateY(-2px); border-color: rgba(96,165,250,.45)}
  .media{position:relative; background: rgba(255,255,255,.03); aspect-ratio: 3 / 2; width:100%}
  .media img{width:100%; height:100%; object-fit:cover; display:block}
  .chip{
    position:absolute; bottom:8px; right:8px; padding:5px 9px;
    border-radius:999px; background: rgba(15,23,42,.75);
    border:1px solid var(--stroke); font-size:11px;
  }
  .body{padding:10px; display:flex; flex-direction:column; gap:8px; flex:1}
  .title{font-weight:900; font-size:13px; line-height:1.3; min-height:38px}
  .meta{font-size:11px; color:var(--muted); display:flex; gap:8px; flex-wrap:wrap; align-items:center}

  /* âœ… status colors */
  .st-available{color:var(--ok); font-weight:900}
  .st-low{color:var(--warn); font-weight:900}
  .st-out{color:var(--bad); font-weight:900}

  .buyRow{ margin-top:9px; display:flex; gap:8px; align-items:stretch; width:100% }
  .qtyMini{
    display:flex; align-items:center; gap:6px; padding:6px;
    border-radius:14px; border:1px solid var(--stroke);
    background: rgba(255,255,255,.06); flex:0 0 auto;
  }
  .qMiniBtn{
    width:34px; height:34px; border-radius:10px;
    border:1px solid var(--stroke); background: rgba(255,255,255,.06);
    color:var(--text); cursor:pointer; font-weight:900; display:grid; place-items:center;
  }
  .qMiniVal{
    min-width:40px; text-align:center; border:1px solid var(--stroke);
    background: rgba(255,255,255,.04); border-radius:12px;
    padding:6px; font-weight:900; font-size:13px;
  }
  .addBtn{
    width:100%; padding:10px 10px; border-radius:14px;
    border:1px solid rgba(96,165,250,.35);
    background: linear-gradient(135deg, rgba(96,165,250,.22), rgba(167,139,250,.15));
    font-weight:900; font-size:12px; cursor:pointer; color:var(--text);
  }
  .empty{ padding:24px; border:1px dashed var(--stroke); border-radius: var(--radius); color:var(--muted); text-align:center; }
  .loader{ display:flex; gap:10px; align-items:center; justify-content:center; padding:20px; color:var(--muted) }
  .errorBox{
    padding:18px; border-radius:12px;
    background:rgba(244,63,94,.06); border:1px solid rgba(244,63,94,.12);
    color:#fecaca; text-align:center
  }
  .retryBtn{
    margin-top:12px; padding:8px 12px; border-radius:12px;
    background:linear-gradient(135deg,var(--accent),var(--accent2));
    border:none; color:#061426; font-weight:900; cursor:pointer
  }

  /* Drawer */
  .overlay{ position:fixed; inset:0; background: rgba(0,0,0,.55); backdrop-filter: blur(4px); display:none; z-index:50; }
  .overlay.show{ display:block; }
  .drawer{
    position:fixed; top:0; bottom:0; right:0; left:auto;
    width:min(420px,92vw);
    background: linear-gradient(180deg, rgba(15,23,42,.95), rgba(2,6,23,.95));
    border-left:1px solid var(--stroke);
    box-shadow: var(--shadow);
    transform: translateX(110%);
    transition: transform .2s ease;
    z-index:60;
    display:flex; flex-direction:column;

    /* âœ… Safe area Ù„Ù„Ø¢ÙŠÙÙˆÙ† */
    padding-bottom: env(safe-area-inset-bottom);
  }
  .drawer.open{ transform: translateX(0); }
  .dHead{ padding:14px 14px; display:flex; justify-content:space-between; align-items:center; border-bottom:1px solid var(--stroke); }
  .dTitle{ font-weight:900 }
  .xBtn{ padding:8px 10px; border-radius:12px; border:1px solid var(--stroke); background: rgba(255,255,255,.06); cursor:pointer; }
  .dBody{ padding:12px; overflow:auto; flex:1 }
  .item{
    border:1px solid var(--stroke);
    background: rgba(255,255,255,.05);
    border-radius:16px;
    padding:10px;
    display:flex; gap:10px; align-items:center;
    margin-bottom:10px;
  }
  .thumb{
    width:56px; height:56px; border-radius:14px;
    border:1px solid var(--stroke);
    object-fit:cover; background: rgba(255,255,255,.04);
    flex:0 0 auto;
  }
  .iInfo{ flex:1; min-width:0 }
  .iName{ font-weight:900; font-size:13px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis }
  .iMeta{ font-size:11px; color:var(--muted); margin-top:3px }
  .qtyBox{ display:flex; align-items:center; gap:6px; flex:0 0 auto; }
  .qBtn{
    width:32px; height:32px; border-radius:12px;
    border:1px solid var(--stroke);
    background: rgba(255,255,255,.06);
    color:var(--text); cursor:pointer; font-weight:900;
  }
  .qVal{
    width:40px; text-align:center;
    border:1px solid var(--stroke);
    background: rgba(255,255,255,.04);
    border-radius:12px;
    padding:7px 6px; font-weight:900; font-size:12px;
  }
  .rmBtn{
    margin-top:6px; font-size:11px; color: #fca5a5;
    cursor:pointer; user-select:none;
  }
  .dFoot{
    padding:12px; border-top:1px solid var(--stroke);
    display:flex; gap:10px; flex-wrap:wrap;
    background: rgba(255,255,255,.03);
  }
  .footBtn{
    flex:1; padding:12px 12px; border-radius:16px;
    border:1px solid var(--stroke);
    background: rgba(255,255,255,.06);
    color:var(--text); font-weight:900;
    cursor:pointer; text-align:center;
  }
  .primary{
    border-color: rgba(96,165,250,.45);
    background: linear-gradient(135deg, rgba(96,165,250,.28), rgba(167,139,250,.18));
  }

  /* âœ… Ù…ÙˆØ¨Ø§ÙŠÙ„: Ù…Ù†ØªØ¬ÙŠÙ† Ø¬Ù†Ø¨ Ø¨Ø¹Ø¶ 100% */
  @media (max-width:720px){
    .topbar{ flex-direction:column; align-items:stretch; gap:10px; }
    .input{ width:100%; max-width:100%; }
    .grid{
      grid-template-columns: repeat(2, minmax(0, 1fr)); /* âœ… Ø¯Ù‡ Ø«Ø§Ø¨Øª Ø¹Ù„Ù‰ Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„ */
      gap:10px;
    }
    .drawer{ width:100%; max-width:480px; }
    /* âœ… Ø¹Ù„Ù‰ Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„ Ù†Ù‚Ù„Ù„ hover effect */
    .card:hover{ transform:none; }
  }

  /* âœ… Ø´Ø§Ø´Ø§Øª ØµØºÙŠØ±Ø© Ø¬Ø¯Ù‹Ø§: Ø¨Ø±Ø¶Ù‡ 2 Ø¬Ù†Ø¨ Ø¨Ø¹Ø¶ */
  @media (max-width:360px){
    .grid{ grid-template-columns: repeat(2, minmax(0, 1fr)); gap:8px; }
    .title{ font-size:12px; min-height:34px; }
    .qMiniBtn{ width:32px; height:32px; }
    .qMiniVal{ min-width:34px; }
  }

  :focus{ outline:3px solid rgba(96,165,250,.2); outline-offset:3px; }

  /* âœ… Footer */
  .site-footer{
    margin-top:auto;
    padding:16px 16px 22px;
    text-align:center;
    color:var(--muted);
    border-top:1px solid var(--stroke);
    background: rgba(2,6,23,.25);
    backdrop-filter: blur(10px);
    padding-bottom: calc(22px + env(safe-area-inset-bottom));
  }
  .site-footer .line1{ font-weight:900; color:#cbd5e1; }
  .site-footer .line2{ margin-top:6px; font-weight:800; }
  </style>
</head>
<body>
  <header class="topbar">
    <div class="brand">
      <div class="logo">
        <img id="siteLogo" src="images/bslogo.webp" alt="BS Logo"
          onerror="this.onerror=null;this.style.display='none';this.parentElement.textContent='BS'">
      </div>
      <div>
        <div class="brand-title">B.S Medical &amp; Aesthetic</div>
        <div class="brand-sub">Ø£Ø¶Ù Ù„Ù„Ø³Ù„Ø© Ø«Ù… Ø£ÙƒÙ…Ù„ Ø§Ù„Ø·Ù„Ø¨</div>
      </div>
    </div>

    <div class="actions">
      <input id="q" class="input" placeholder="Ø§Ø¨Ø­Ø« Ø¹Ù† Ù…Ù†ØªØ¬..." aria-label="Ø§Ø¨Ø­Ø« Ø¹Ù† Ù…Ù†ØªØ¬" />
      <select id="cat" class="input" aria-label="Ø§Ø®ØªØ± ÙØ¦Ø©"><option value="">ÙƒÙ„ Ø§Ù„ÙØ¦Ø§Øª</option></select>
      <button id="cartBtn" class="addBtn" aria-haspopup="dialog" aria-expanded="false" aria-controls="drawer">
        ğŸ›’ Ø§Ù„Ø³Ù„Ø© <span id="cartCount" class="qMiniVal">0</span>
      </button>
    </div>
  </header>

  <main class="container">
    <div id="statusArea"></div>
    <div id="grid" class="grid" role="list"></div>
  </main>

  <div id="overlay" class="overlay" tabindex="-1"></div>
  <aside id="drawer" class="drawer" aria-hidden="true" role="dialog" aria-label="Ø³Ù„Ø© Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª">
    <div class="dHead">
      <div class="dTitle">ğŸ›’ Ø§Ù„Ø³Ù„Ø©</div>
      <button id="closeDrawer" class="xBtn" aria-label="Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ø³Ù„Ø©">Ø¥ØºÙ„Ø§Ù‚</button>
    </div>
    <div class="dBody" id="cartList"></div>
    <div class="dFoot">
      <button id="clearCart" class="footBtn">ØªÙØ±ÙŠØº Ø§Ù„Ø³Ù„Ø©</button>
      <a id="checkout" class="footBtn primary" href="order.html">Ø¥ØªÙ…Ø§Ù… Ø§Ù„Ø·Ù„Ø¨</a>
    </div>
  </aside>

  <div id="toast" style="display:none;position:fixed;bottom:16px;left:16px;padding:10px 12px;border-radius:12px;background:rgba(0,0,0,.6);color:#fff;"></div>

  <footer class="site-footer">
    <div class="line1">Axentro â€“ All Rights Reserved 2024 Â©</div>
    <div class="line2">By Ahmed Hamouda</div>
  </footer>

<script>
/* CONFIG */
const API_URL = "https://script.google.com/macros/s/AKfycbwsPPw3UiW6TBngBcbFxY4E8rB7JYgK1W2LRn0WaS9C7OitA1FgZ1vAz9Qr1u_ojlZ8/exec";
const PROD_CACHE_KEY = "AX_PRODUCTS_CACHE_V1";
const PROD_CACHE_TS  = "AX_PRODUCTS_CACHE_TS_V1";
const CACHE_TTL_MS   = 10 * 60 * 1000;

const IMG_PLACEHOLDER = "https://via.placeholder.com/600x400?text=No+Image";
function resolveImageById(id){ return `images/${id}.webp`; }

let products = [];
const state = { q:"", cat:"" };

/* DOM refs */
const elGrid = document.getElementById("grid");
const statusArea = document.getElementById("statusArea");
const elQ = document.getElementById("q");
const elCat = document.getElementById("cat");
const toastEl = document.getElementById("toast");
const cartCountEl = document.getElementById("cartCount");

const overlay = document.getElementById("overlay");
const drawer = document.getElementById("drawer");
const closeDrawerBtn = document.getElementById("closeDrawer");
const cartList = document.getElementById("cartList");
const clearCartBtn = document.getElementById("clearCart");
const checkout = document.getElementById("checkout");
const cartBtn = document.getElementById("cartBtn");

function showToast(msg, time=1600){
  toastEl.textContent = msg; toastEl.style.display='block';
  clearTimeout(showToast._t);
  showToast._t = setTimeout(()=> toastEl.style.display='none', time);
}

/* debounce helper */
function debounce(fn, wait=250){ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn.apply(this,a), wait); }; }

/* IMAGE lazy loader + once-loaded guard */
const imgObserver = new IntersectionObserver((entries)=>{
  entries.forEach(e=>{
    if(!e.isIntersecting) return;
    const img = e.target;
    const src = img.dataset.src;
    if(src && !img.dataset.loaded){
      img.src = src;
      img.onload = ()=> { img.dataset.loaded = "1"; img.classList.remove('loading'); };
      img.onerror = ()=> { img.src = IMG_PLACEHOLDER; img.dataset.loaded = "1"; img.classList.remove('loading'); };
    }
    imgObserver.unobserve(img);
  });
}, { rootMargin: "200px 0px", threshold: 0.01 });

/* caching helpers */
function saveProductsCache(list){
  localStorage.setItem(PROD_CACHE_KEY, JSON.stringify(list));
  localStorage.setItem(PROD_CACHE_TS, String(Date.now()));
}
function loadProductsFromCache(){
  try{
    const raw = localStorage.getItem(PROD_CACHE_KEY);
    const ts = Number(localStorage.getItem(PROD_CACHE_TS)||0);
    if(!raw) return null;
    const list = JSON.parse(raw);
    if(!Array.isArray(list)) return null;
    return {list,ts};
  }catch(e){ return null; }
}

/* fetch */
async function fetchProductsFromApi(){
  const res = await fetch(API_URL, { cache:"no-store" });
  if(!res.ok) throw new Error("HTTP " + res.status);
  const data = await res.json();
  return Array.isArray(data) ? data : [];
}

/* CART */
const LS_KEY = "AX_CART_V1";
function getCart(){ try{ const r=localStorage.getItem(LS_KEY); return r?JSON.parse(r):[]; }catch(e){ return []; } }

const draftQty = Object.create(null);

function setCart(items){
  localStorage.setItem(LS_KEY, JSON.stringify(items));
  const ids = items.map(it => it.id);
  Object.keys(draftQty).forEach(k => { if(!ids.includes(k)) delete draftQty[k]; });
  items.forEach(it => { draftQty[it.id] = Number(it.qty) || 0; });
  updateCartBadge();
}
function updateCartBadge(){
  const total = getCart().reduce((s,it)=>s+(Number(it.qty)||0),0);
  cartCountEl.textContent = total;
}
function cartTotalCount(){
  return getCart().reduce((s,it)=>s + (Number(it.qty)||0), 0);
}

/* UTIL */
function escapeHtml(s){ return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
function escapeAttr(s){ return String(s||'').replace(/"/g,'&quot;'); }
function statusClass(av){ if(av==="Low stock") return "st-low"; if(av==="Out of stock") return "st-out"; return "st-available"; }

/* Drawer open-once flag (session) */
const AUTO_OPEN_KEY = "AX_CART_AUTO_OPENED";

/* Drawer functions */
let _lastFocusedBeforeDrawer = null;
function openDrawer(){
  _lastFocusedBeforeDrawer = document.activeElement;
  overlay.classList.add("show");
  drawer.classList.add("open");
  drawer.setAttribute("aria-hidden","false");
  cartBtn?.setAttribute("aria-expanded","true");
  try { closeDrawerBtn.focus(); } catch(e){}
  document.documentElement.style.overflow = "hidden";
  renderCart();
}
function closeDrawerFn(){
  overlay.classList.remove("show");
  drawer.classList.remove("open");
  drawer.setAttribute("aria-hidden","true");
  cartBtn?.setAttribute("aria-expanded","false");
  document.documentElement.style.overflow = "";
  if(_lastFocusedBeforeDrawer && typeof _lastFocusedBeforeDrawer.focus === "function"){
    try { _lastFocusedBeforeDrawer.focus(); } catch(e){}
  }
}
cartBtn?.addEventListener("click", openDrawer);
closeDrawerBtn?.addEventListener("click", closeDrawerFn);
overlay?.addEventListener("click", closeDrawerFn);
document.addEventListener("keydown", (ev) => { if(ev.key === "Escape" && drawer.classList.contains("open")) closeDrawerFn(); });

/* renderCart */
function renderCart(){
  const cart = getCart();
  cartList.innerHTML = "";
  checkout.style.pointerEvents = cart.length ? "auto" : "none";
  checkout.style.opacity = cart.length ? "1" : ".45";

  if(cart.length === 0){
    cartList.innerHTML = `<div class="empty">Ø§Ù„Ø³Ù„Ø© ÙØ§Ø±ØºØ©. Ø£Ø¶Ù Ù…Ù†ØªØ¬Ø§Øª Ù…Ù† Ø§Ù„ÙƒØªØ§Ù„ÙˆØ¬.</div>`;
    return;
  }

  cart.forEach(it=>{
    const p = products.find(x=>String(x.id)===String(it.id)) || { id: it.id, name: "Ù…Ù†ØªØ¬ ØºÙŠØ± Ù…ØªØ§Ø­", category: "-", availability: "Unknown" };

    const row = document.createElement("div");
    row.className = "item";
    row.innerHTML = `
      <img class="thumb" loading="lazy" decoding="async"
        src="${resolveImageById(escapeAttr(p.id))}"
        onerror="this.onerror=null;this.src='${IMG_PLACEHOLDER}'"
        alt="${escapeHtml(p.name||'')}">
      <div class="iInfo">
        <div class="iName">${escapeHtml(p.name||p.id)}</div>
        <div class="iMeta">${escapeHtml(p.category||'-')} â€¢ <span class="${statusClass(p.availability)}">${escapeHtml(p.availability)}</span> â€¢ ${escapeHtml(p.id)}</div>
        <div class="rmBtn" data-act="rm" data-id="${escapeAttr(p.id)}" role="button" tabindex="0">Ø­Ø°Ù Ù…Ù† Ø§Ù„Ø³Ù„Ø©</div>
      </div>
      <div class="qtyBox">
        <button class="qBtn" data-act="minus" data-id="${escapeAttr(p.id)}" aria-label="Ø¥Ù†Ù‚Ø§Øµ Ø§Ù„ÙƒÙ…ÙŠØ©">âˆ’</button>
        <div class="qVal">${Number(it.qty)||1}</div>
        <button class="qBtn" data-act="plus" data-id="${escapeAttr(p.id)}" aria-label="Ø²ÙŠØ§Ø¯Ø© Ø§Ù„ÙƒÙ…ÙŠØ©">+</button>
      </div>
    `;
    cartList.appendChild(row);
  });
}

/* Delegation Ø¯Ø§Ø®Ù„ drawer */
cartList.addEventListener("click", (ev)=>{
  const btn = ev.target.closest("[data-act]");
  if(!btn) return;
  const act = btn.getAttribute("data-act");
  const id  = btn.getAttribute("data-id");
  if(!id) return;

  if(act === "rm"){ removeItem(id); return; }

  const cart = getCart();
  const it = cart.find(x=>String(x.id)===String(id));
  const current = Number(it?.qty)||1;

  if(act === "plus") setQtyFromCatalog(id, current+1);
  if(act === "minus") setQtyFromCatalog(id, Math.max(1, current-1));
});
cartList.addEventListener("keydown", (ev)=>{
  const btn = ev.target.closest("[data-act]");
  if(!btn) return;
  if(ev.key !== "Enter" && ev.key !== " ") return;
  ev.preventDefault();
  btn.click();
});

/* Catalog render */
function renderCatalog(){
  const q = String(state.q||"").toLowerCase().trim();
  const cat = state.cat;

  const cart = getCart();
  const cartQty = new Map(cart.map(it => [String(it.id), Number(it.qty)||0]));

  const filtered = products.filter(p=>{
    const okQ = !q || (p.name && p.name.toLowerCase().includes(q)) || (p.id && p.id.toLowerCase().includes(q));
    const okC = !cat || p.category === cat;
    return okQ && okC;
  });

  const keepSet = new Set(filtered.map(p=>p.id));
  Array.from(elGrid.children).forEach(child=>{
    const pid = child.dataset.pid;
    if(pid && !keepSet.has(pid)) child.remove();
  });

  filtered.forEach(p=>{
    let card = elGrid.querySelector(`[data-pid="${CSS.escape(p.id)}"]`);

    const inCartQty = cartQty.get(String(p.id)) || 0;
    const draftVal = draftQty[p.id] ?? inCartQty ?? 0;

    if(card){
      const titleEl = card.querySelector(".title");
      const pidEl = card.querySelector(".meta .pid");
      const statusEl = card.querySelector(".meta .st");
      const qValEl = card.querySelector("[data-mini-val]");

      if(titleEl) titleEl.textContent = p.name || "-";
      if(pidEl) pidEl.textContent = p.id || "";
      if(statusEl){
        statusEl.textContent = p.availability;
        statusEl.className = "st " + statusClass(p.availability);
      }
      if(qValEl) qValEl.textContent = draftVal;

      const existingImg = card.querySelector("img.js-img");
      if(existingImg && !existingImg.dataset.loaded){
        existingImg.dataset.src = resolveImageById(p.id);
        imgObserver.observe(existingImg);
      }
      return;
    }

    card = document.createElement("div");
    card.className = "card";
    card.dataset.pid = p.id;

    card.innerHTML = `
      <div class="media">
        <img class="js-img loading" alt="${escapeHtml(p.name||'')}" />
        <div class="chip">${escapeHtml(p.category||'')}</div>
      </div>
      <div class="body">
        <div class="title">${escapeHtml(p.name||'-')}</div>
        <div class="meta">
          <span class="st ${statusClass(p.availability)}">${escapeHtml(p.availability)}</span>
          <span class="pid" style="opacity:.85;margin-inline-start:8px">${escapeHtml(p.id||'')}</span>
        </div>

        <div class="buyRow">
          <div class="qtyMini" aria-label="ÙƒÙ…ÙŠØ© Ø§Ù„Ù…Ù†ØªØ¬">
            <button class="qMiniBtn" data-mini-minus="${escapeAttr(p.id)}" aria-label="Ø¥Ù†Ù‚Ø§Øµ">âˆ’</button>
            <div class="qMiniVal" data-mini-val="${escapeAttr(p.id)}">${draftVal}</div>
            <button class="qMiniBtn" data-mini-plus="${escapeAttr(p.id)}" aria-label="Ø²ÙŠØ§Ø¯Ø©">+</button>
          </div>
          <button class="addBtn" data-add="${escapeAttr(p.id)}">${p.availability === "Out of stock" ? "ØºÙŠØ± Ù…ØªØ§Ø­" : "â• Ø£Ø¶Ù Ù„Ù„Ø³Ù„Ø©"}</button>
        </div>
      </div>
    `;

    const imgEl = card.querySelector("img.js-img");
    imgEl.dataset.src = resolveImageById(p.id);
    imgObserver.observe(imgEl);

    elGrid.appendChild(card);
  });
}

/* delegated events on grid */
elGrid.addEventListener('click', (ev)=>{
  const addBtn = ev.target.closest('[data-add]');
  if(addBtn){ addToCart(addBtn.getAttribute('data-add')); return; }

  const plus = ev.target.closest('[data-mini-plus]');
  if(plus){
    const pid = plus.getAttribute('data-mini-plus');
    const inCart = getCart().find(x=>x.id===pid)?.qty || 0;
    if(inCart>0) setQtyFromCatalog(pid, inCart+1);
    else { draftQty[pid] = (draftQty[pid]||0) + 1; renderCatalog(); }
    return;
  }

  const minus = ev.target.closest('[data-mini-minus]');
  if(minus){
    const pid = minus.getAttribute('data-mini-minus');
    const inCart = getCart().find(x=>x.id===pid)?.qty || 0;
    if(inCart>0) setQtyFromCatalog(pid, Math.max(1,inCart-1));
    else { draftQty[pid] = Math.max(0,(draftQty[pid]||0)-1); renderCatalog(); }
    return;
  }
});

/* CART schema */
const CART_VER_KEY = "AX_CART_SCHEMA_VER"; const CART_SCHEMA_VER = "2";
function initCartSchema(){
  const v = localStorage.getItem(CART_VER_KEY);
  if(v!==CART_SCHEMA_VER){
    localStorage.setItem(CART_VER_KEY, CART_SCHEMA_VER);
    localStorage.setItem(LS_KEY, JSON.stringify([]));
  }
}

/* set qty + add */
function setQtyFromCatalog(pid, qty){
  const p = products.find(x=>x.id===pid);
  if(!p) return;
  if(p.availability === "Out of stock"){ showToast("Ù‡Ø°Ø§ Ø§Ù„Ù…Ù†ØªØ¬ ØºÙŠØ± Ù…ØªØ§Ø­ Ø­Ø§Ù„ÙŠÙ‹Ø§."); return; }

  const cart = getCart();
  const idx = cart.findIndex(x=>x.id===pid);
  const q = Math.max(0, Number(qty)||0);

  if(q===0){
    if(idx>=0) cart.splice(idx,1);
  } else {
    if(idx>=0) cart[idx].qty = q;
    else cart.push({id:pid,qty:q});
  }

  setCart(cart);
  if (drawer.classList.contains("open")) renderCart();
  renderCatalog();
  showToast("ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø³Ù„Ø©");
}

function addToCart(pid){
  const p = products.find(x=>x.id===pid); if(!p) return;
  if(p.availability === "Out of stock"){ showToast("Ù‡Ø°Ø§ Ø§Ù„Ù…Ù†ØªØ¬ ØºÙŠØ± Ù…ØªØ§Ø­ Ø­Ø§Ù„ÙŠÙ‹Ø§."); return; }

  const prevCount = cartTotalCount();
  const inCart = getCart().find(x=>x.id===pid)?.qty || 0;
  if(inCart>0){
    showToast("Ø§Ù„Ù…Ù†ØªØ¬ Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ Ø§Ù„Ø³Ù„Ø©. Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø¹Ø¯Ø§Ø¯ Ù„Ù„ØªØ¹Ø¯ÙŠÙ„ âœ…");
    return;
  }

  const q = draftQty[pid] || 1;
  setQtyFromCatalog(pid, q);
  draftQty[pid]=q;
  showToast("ØªÙ…Øª Ø§Ù„Ø¥Ø¶Ø§ÙØ© Ù„Ù„Ø³Ù„Ø© âœ…");

  const alreadyOpened = sessionStorage.getItem(AUTO_OPEN_KEY) === "1";
  if(prevCount === 0 && !alreadyOpened){
    sessionStorage.setItem("AX_CART_AUTO_OPENED", "1");
    setTimeout(()=> { try { openDrawer(); } catch(e){} }, 220);
  }
}

function removeItem(pid){
  setCart(getCart().filter(x=>x.id!==pid));
  renderCart();
  renderCatalog();
}

/* INIT & data load */
async function hydrateProducts(){
  statusArea.innerHTML = '';
  const cached = loadProductsFromCache();
  const hasCache = cached && cached.list && cached.list.length;

  if(hasCache){
    products = cached.list;
    renderCatalog();
  }else{
    elGrid.innerHTML = '<div class="loader">Ø¬Ø§Ø±Ù ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª...</div>';
  }

  try{
    const fresh = await fetchProductsFromApi();
    products = Array.isArray(fresh) ? fresh : [];
    saveProductsCache(products);
    renderCatalog();
  }catch(err){
    console.error(err);
    statusArea.innerHTML = `<div class="errorBox">Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª. ØªØ£ÙƒØ¯ Ù…Ù† Ù†Ø´Ø± Ø§Ù„Ù€ API. <button id="retryFetch" class="retryBtn">Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©</button></div>`;
    document.getElementById('retryFetch')?.addEventListener('click', ()=>{ statusArea.innerHTML=''; hydrateProducts(); });
    if(!hasCache) elGrid.innerHTML = `<div class="empty">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ø¹Ø±Ø¶ Ø­Ø§Ù„ÙŠØ§Ù‹.</div>`;
    else showToast("Ø¹Ø±Ø¶ Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ù…Ø®Ø²Ù†Ø© Ù…Ø­Ù„ÙŠØ§Ù‹.");
  }

  updateCartBadge();
  renderCats();
}

/* search */
const onSearch = debounce((val)=>{ state.q = val; renderCatalog(); }, 220);
elQ.addEventListener('input', e=> onSearch(e.target.value));
elCat.addEventListener('change', e=>{ state.cat = e.target.value; renderCatalog(); });

/* categories */
function renderCats(){
  const cats = Array.from(new Set(products.map(p=>p.category))).filter(Boolean).sort();
  elCat.innerHTML = `<option value="">ÙƒÙ„ Ø§Ù„ÙØ¦Ø§Øª</option>`;
  cats.forEach(c=>{
    const opt=document.createElement('option');
    opt.value=c; opt.textContent=c;
    elCat.appendChild(opt);
  });
}

/* clearCart */
clearCartBtn?.addEventListener('click', ()=>{
  setCart([]);
  renderCart();
  renderCatalog();
  showToast("ØªÙ… ØªÙØ±ÙŠØº Ø§Ù„Ø³Ù„Ø©");
});

/* setup */
initCartSchema();
hydrateProducts();
</script>
</body>
</html>
