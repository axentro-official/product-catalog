<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ÙƒØªØ§Ù„ÙˆØ¬ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</title>
  <style>
    :root{
      --bg1:#0b1020; --bg2:#0f172a;
      --stroke:#ffffff1a; --text:#e5e7eb; --muted:#94a3b8;
      --shadow: 0 18px 50px rgba(0,0,0,.45);
      --radius:18px;
      --accent:#60a5fa; --accent2:#a78bfa;
      --ok:#22c55e; --warn:#facc15; --bad:#ef4444;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: system-ui, -apple-system, "Segoe UI", Tahoma, Arial;
      color:var(--text);
      background:
        radial-gradient(900px 500px at 10% 10%, rgba(96,165,250,.25), transparent 55%),
        radial-gradient(700px 500px at 90% 20%, rgba(167,139,250,.18), transparent 55%),
        linear-gradient(180deg, var(--bg1), var(--bg2));
      min-height:100vh;
      -webkit-font-smoothing:antialiased;
    }
    a{color:inherit;text-decoration:none}
    .topbar{
      position:sticky; top:0; z-index:10;
      display:flex; gap:12px; align-items:center; justify-content:space-between;
      padding:14px 16px;
      background: linear-gradient(180deg, rgba(15,23,42,.88), rgba(15,23,42,.55));
      border-bottom:1px solid var(--stroke);
      backdrop-filter: blur(12px);
    }
    .brand{display:flex; align-items:center; gap:12px}
    .logo{ width:44px; height:44px; border-radius:999px; display:grid; place-items:center;
      background: linear-gradient(135deg, rgba(96,165,250,.35), rgba(167,139,250,.25));
      border:1px solid var(--stroke); box-shadow: var(--shadow); overflow:hidden; padding:5px; }
    .logo img{ width:100%; height:100%; object-fit:contain; display:block; }
    .brand-title{font-size:16px;font-weight:900}
    .brand-sub{font-size:12px;color:var(--muted)}
    .actions{display:flex; gap:10px; align-items:center; flex-wrap:wrap; justify-content:flex-end}
    .input{ width:220px; max-width:85vw; padding:12px; border-radius:14px; border:1px solid var(--stroke);
      background: rgba(255,255,255,.06); color:var(--text); outline:none; font-size:14px; }
    .container{max-width:1100px; margin:18px auto; padding:0 16px}
    .grid{ display:grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap:12px; }
    .card{ border-radius: var(--radius); overflow:hidden; border:1px solid var(--stroke);
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      box-shadow: var(--shadow); transition: transform .18s ease, border-color .18s ease; display:flex; flex-direction:column; min-height:220px;}
    .media{position:relative; background: rgba(255,255,255,.03); aspect-ratio: 3 / 2; width:100%}
    .media img{width:100%; height:100%; object-fit:cover; display:block}
    .chip{position:absolute; bottom:8px; right:8px; padding:5px 9px; border-radius:999px; background: rgba(15,23,42,.75);
      border:1px solid var(--stroke); font-size:11px;}
    .body{padding:10px; display:flex; flex-direction:column; gap:8px; flex:1}
    .title{font-weight:900; font-size:13px; line-height:1.3; min-height:38px}
    .meta{font-size:11px; color:var(--muted); display:flex; gap:8px; flex-wrap:wrap; align-items:center}
    .buyRow{ margin-top:9px; display:flex; gap:8px; align-items:stretch; width:100% }
    .qtyMini{ display:flex; align-items:center; gap:6px; padding:6px; border-radius:14px; border:1px solid var(--stroke); background: rgba(255,255,255,.06); flex:0 0 auto; }
    .qMiniBtn{ width:34px; height:34px; border-radius:10px; border:1px solid var(--stroke); background: rgba(255,255,255,.06); color:var(--text); cursor:pointer; font-weight:900; display:grid; place-items:center; }
    .qMiniVal{ min-width:40px; text-align:center; border:1px solid var(--stroke); background: rgba(255,255,255,.04); border-radius:12px; padding:6px; font-weight:900; font-size:13px; }
    .addBtn{ width:100%; padding:10px 10px; border-radius:14px; border:1px solid rgba(96,165,250,.35); background: linear-gradient(135deg, rgba(96,165,250,.22), rgba(167,139,250,.15)); font-weight:900; font-size:12px; cursor:pointer; color:var(--text); }
    .empty{ padding:24px; border:1px dashed var(--stroke); border-radius: var(--radius); color:var(--muted); text-align:center; }
    .loader{ display:flex; gap:10px; align-items:center; justify-content:center; padding:20px; color:var(--muted) }
    .errorBox{ padding:18px; border-radius:12px; background:rgba(244,63,94,.06); border:1px solid rgba(244,63,94,.12); color:#fecaca; text-align:center }
    .retryBtn{ margin-top:12px; padding:8px 12px; border-radius:12px; background:linear-gradient(135deg,var(--accent),var(--accent2)); border:none; color:#061426; font-weight:900; cursor:pointer }
    @media (max-width:920px){ .grid{ grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)) } }
    @media (max-width:720px){ .topbar{ flex-direction:column; align-items:stretch; gap:10px; } .input{ width:100%; max-width:100%; } .grid{ grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap:10px } }
  </style>
</head>
<body>
  <header class="topbar">
    <div class="brand">
      <div class="logo"><img id="siteLogo" src="images/bslogo.webp" alt="BS Logo" onerror="this.onerror=null;this.style.display='none';this.parentElement.textContent='BS'"></div>
      <div><div class="brand-title">ÙƒØªØ§Ù„ÙˆØ¬ Ù…Ù†ØªØ¬Ø§Øª BS ğŸ“¦</div><div class="brand-sub">Ø£Ø¶Ù Ù„Ù„Ø³Ù„Ø© Ø«Ù… Ø£ÙƒÙ…Ù„ Ø§Ù„Ø·Ù„Ø¨</div></div>
    </div>

    <div class="actions">
      <input id="q" class="input" placeholder="Ø§Ø¨Ø­Ø« Ø¹Ù† Ù…Ù†ØªØ¬..." aria-label="Ø§Ø¨Ø­Ø« Ø¹Ù† Ù…Ù†ØªØ¬" />
      <select id="cat" class="input" aria-label="Ø§Ø®ØªØ± ÙØ¦Ø©"><option value="">ÙƒÙ„ Ø§Ù„ÙØ¦Ø§Øª</option></select>
      <button id="cartBtn" class="addBtn" aria-haspopup="dialog" aria-expanded="false" aria-controls="drawer">ğŸ›’ Ø§Ù„Ø³Ù„Ø© <span id="cartCount" class="qMiniVal">0</span></button>
    </div>
  </header>

  <main class="container">
    <div id="statusArea"></div>
    <div id="grid" class="grid" role="list"></div>
  </main>

  <div id="overlay" style="display:none"></div>
  <div id="toast" style="display:none;position:fixed;bottom:16px;left:16px;padding:10px 12px;border-radius:12px;background:rgba(0,0,0,.6);color:#fff;"></div>

<script>
/* CONFIG */
const API_URL = "https://script.google.com/macros/s/AKfycbwsPPw3UiW6TBngBcbFxY4E8rB7JYgK1W2LRn0WaS9C7OitA1FgZ1vAz9Qr1u_ojlZ8/exec";
const PROD_CACHE_KEY = "AX_PRODUCTS_CACHE_V1";
const PROD_CACHE_TS  = "AX_PRODUCTS_CACHE_TS_V1";
const CACHE_TTL_MS   = 10 * 60 * 1000;
const IMG_PLACEHOLDER = "https://via.placeholder.com/600x400?text=No+Image";

let products = [];
const state = { q:"", cat:"" };

const elGrid = document.getElementById("grid");
const statusArea = document.getElementById("statusArea");
const elQ = document.getElementById("q");
const elCat = document.getElementById("cat");
const toastEl = document.getElementById("toast");
const cartCountEl = document.getElementById("cartCount");

function showToast(msg, time=1600){
  toastEl.textContent = msg; toastEl.style.display='block';
  clearTimeout(showToast._t);
  showToast._t = setTimeout(()=> toastEl.style.display='none', time);
}

/* debounce helper */
function debounce(fn, wait=250){ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn.apply(this,a), wait); }; }

/* IMAGE lazy loader + once-loaded guard */
const imgObserver = new IntersectionObserver((entries)=>{
  entries.forEach(e=>{
    if(e.isIntersecting){
      const img = e.target;
      const src = img.dataset.src;
      if(src && !img.dataset.loaded){
        img.src = src;
        img.onload = ()=> { img.dataset.loaded = "1"; img.classList.remove('loading'); };
        img.onerror = ()=> { img.src = IMG_PLACEHOLDER; img.dataset.loaded = "1"; };
      }
      imgObserver.unobserve(img);
    }
  });
}, { rootMargin: "200px 0px", threshold: 0.01 });

/* caching helpers */
function saveProductsCache(list){ localStorage.setItem(PROD_CACHE_KEY, JSON.stringify(list)); localStorage.setItem(PROD_CACHE_TS, String(Date.now())); }
function loadProductsFromCache(){ try{ const raw=localStorage.getItem(PROD_CACHE_KEY); const ts=Number(localStorage.getItem(PROD_CACHE_TS)||0); if(!raw) return null; const list=JSON.parse(raw); if(!Array.isArray(list)) return null; return {list,ts}; }catch(e){ return null; } }

/* fetch */
async function fetchProductsFromApi(){
  const res = await fetch(API_URL, { cache:"no-store" });
  if(!res.ok) throw new Error("HTTP " + res.status);
  const data = await res.json();
  return Array.isArray(data) ? data : [];
}

/* CART (simple) */
const LS_KEY = "AX_CART_V1";
function getCart(){ try{ const r=localStorage.getItem(LS_KEY); return r?JSON.parse(r):[]; }catch(e){ return []; } }
function setCart(items){ localStorage.setItem(LS_KEY, JSON.stringify(items)); updateCartBadge(); }
function updateCartBadge(){ const total = getCart().reduce((s,it)=>s+(Number(it.qty)||0),0); cartCountEl.textContent = total; }

/* RENDER: efficient, reuses existing cards when possible */
function renderCatalog(){
  const q = String(state.q||"").toLowerCase().trim();
  const cat = state.cat;
  const filtered = products.filter(p=>{
    const okQ = !q || (p.name && p.name.toLowerCase().includes(q)) || (p.id && p.id.toLowerCase().includes(q));
    const okC = !cat || p.category === cat;
    return okQ && okC;
  });

  // Mark existing items; we'll remove ones not in filtered
  const keepSet = new Set(filtered.map(p=>p.id));
  Array.from(elGrid.children).forEach(child=>{
    const pid = child.dataset.pid;
    if(pid && !keepSet.has(pid)) child.remove();
  });

  // For each product in filtered, either update existing card or create it
  filtered.forEach(p=>{
    let card = elGrid.querySelector(`[data-pid="${CSS.escape(p.id)}"]`);
    const inCartQty = (getCart().find(x=>x.id===p.id)?.qty) || 0;
    const draftVal = draftQty[p.id] ?? inCartQty ?? 0;

    if(card){
      // update text parts, but DO NOT reset <img.src> if already loaded
      const titleEl = card.querySelector(".title");
      const metaEl = card.querySelector(".meta .pid");
      const statusEl = card.querySelector(".meta .st");
      const qValEl = card.querySelector("[data-mini-val]");
      if(titleEl) titleEl.textContent = p.name || "-";
      if(metaEl) metaEl.textContent = p.id || "";
      if(statusEl){
        statusEl.textContent = p.availability;
        statusEl.className = "st " + statusClass(p.availability);
      }
      if(qValEl) qValEl.textContent = draftVal;
      return;
    }

    // create new card
    card = document.createElement("div");
    card.className = "card";
    card.dataset.pid = p.id;

    card.innerHTML = `
      <div class="media">
        <img class="js-img loading" alt="${escapeHtml(p.name||'')}" />
        <div class="chip">${escapeHtml(p.category||'')}</div>
      </div>
      <div class="body">
        <div class="title">${escapeHtml(p.name||'-')}</div>
        <div class="meta"><span class="st ${statusClass(p.availability)}">${escapeHtml(p.availability)}</span> <span class="pid" style="opacity:.85;margin-inline-start:8px">${escapeHtml(p.id||'')}</span></div>

        <div class="buyRow">
          <div class="qtyMini" aria-label="ÙƒÙ…ÙŠØ© Ø§Ù„Ù…Ù†ØªØ¬">
            <button class="qMiniBtn" data-mini-minus="${escapeAttr(p.id)}" aria-label="Ø¥Ù†Ù‚Ø§Øµ">âˆ’</button>
            <div class="qMiniVal" data-mini-val="${escapeAttr(p.id)}">${draftVal}</div>
            <button class="qMiniBtn" data-mini-plus="${escapeAttr(p.id)}" aria-label="Ø²ÙŠØ§Ø¯Ø©">+</button>
          </div>
          <button class="addBtn" data-add="${escapeAttr(p.id)}">${p.availability === "Out of stock" ? "ØºÙŠØ± Ù…ØªØ§Ø­" : "â• Ø£Ø¶Ù Ù„Ù„Ø³Ù„Ø©"}</button>
        </div>
      </div>
    `;

    // set data-src for lazy loading; do NOT set src now
    const imgEl = card.querySelector("img.js-img");
    imgEl.dataset.src = (p.image && !p.image.includes("placeholder")) ? p.image : `images/${p.id}.webp`;
    // If image was previously loaded and cached in browser, dataset.loaded could be set â€” but since this is a new element, we rely on observer
    imgObserver.observe(imgEl);

    // append to grid
    elGrid.appendChild(card);
  });

  // delegate events (we rely on event delegation below)
}

/* UTIL */
function escapeHtml(s){ return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
function escapeAttr(s){ return String(s||'').replace(/"/g,'&quot;'); }
function statusClass(av){ if(av==="Low stock") return "st-low"; if(av==="Out of stock") return "st-out"; return "st-available"; }

/* handle delegated clicks for add / mini plus/minus */
elGrid.addEventListener('click', (ev)=>{
  const addBtn = ev.target.closest('[data-add]');
  if(addBtn){
    const pid = addBtn.getAttribute('data-add');
    addToCart(pid);
    return;
  }
  const plus = ev.target.closest('[data-mini-plus]');
  if(plus){
    const pid = plus.getAttribute('data-mini-plus');
    const inCart = getCart().find(x=>x.id===pid)?.qty || 0;
    if(inCart>0) setQtyFromCatalog(pid, inCart+1);
    else { draftQty[pid] = (draftQty[pid]||0) + 1; renderCatalog(); }
    return;
  }
  const minus = ev.target.closest('[data-mini-minus]');
  if(minus){
    const pid = minus.getAttribute('data-mini-minus');
    const inCart = getCart().find(x=>x.id===pid)?.qty || 0;
    if(inCart>0) setQtyFromCatalog(pid, Math.max(1,inCart-1));
    else { draftQty[pid] = Math.max(0,(draftQty[pid]||0)-1); renderCatalog(); }
    return;
  }
});

/* --- cart functions (reuse from previous) --- */
const CART_VER_KEY = "AX_CART_SCHEMA_VER"; const CART_SCHEMA_VER = "2";
function initCartSchema(){ const v = localStorage.getItem(CART_VER_KEY); if(v!==CART_SCHEMA_VER){ localStorage.setItem(CART_VER_KEY, CART_SCHEMA_VER); localStorage.setItem(LS_KEY, JSON.stringify([])); } }
function setQtyFromCatalog(pid, qty){
  const p = products.find(x=>x.id===pid);
  if(!p) return;
  if(p.availability === "Out of stock"){ showToast("Ù‡Ø°Ø§ Ø§Ù„Ù…Ù†ØªØ¬ ØºÙŠØ± Ù…ØªØ§Ø­ Ø­Ø§Ù„ÙŠÙ‹Ø§."); return; }
  const cart = getCart(); const idx = cart.findIndex(x=>x.id===pid); const q = Math.max(0, Number(qty)||0);
  if(q===0){ if(idx>=0) cart.splice(idx,1); } else { if(idx>=0) cart[idx].qty = q; else cart.push({id:pid,qty:q}); }
  setCart(cart); renderCatalog();
  showToast("ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø³Ù„Ø©");
}
function addToCart(pid){
  const p = products.find(x=>x.id===pid); if(!p) return;
  if(p.availability === "Out of stock"){ showToast("Ù‡Ø°Ø§ Ø§Ù„Ù…Ù†ØªØ¬ ØºÙŠØ± Ù…ØªØ§Ø­ Ø­Ø§Ù„ÙŠÙ‹Ø§."); return; }
  const inCart = getCart().find(x=>x.id===pid)?.qty || 0;
  if(inCart>0){ showToast("Ø§Ù„Ù…Ù†ØªØ¬ Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ Ø§Ù„Ø³Ù„Ø©. Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø¹Ø¯Ø§Ø¯ Ù„Ù„ØªØ¹Ø¯ÙŠÙ„ âœ…"); return; }
  const q = draftQty[pid]||1; setQtyFromCatalog(pid, q); draftQty[pid]=q; showToast("ØªÙ…Øª Ø§Ù„Ø¥Ø¶Ø§ÙØ© Ù„Ù„Ø³Ù„Ø© âœ…");
}
function setQty(pid, qty){ const cart = getCart(); const idx = cart.findIndex(x=>x.id===pid); if(idx<0) return; cart[idx].qty = Math.max(1, Number(qty)||1); setCart(cart); renderCatalog(); }
function removeItem(pid){ setCart(getCart().filter(x=>x.id!==pid)); renderCatalog(); }

/* DATALOAD & INIT */
const draftQty = Object.create(null);

async function hydrateProducts(){
  statusArea.innerHTML = '';
  const cached = loadProductsFromCache();
  const now = Date.now();
  const hasCache = cached && cached.list && cached.list.length;
  if(hasCache){ products = cached.list; renderCatalog(); }
  else { elGrid.innerHTML = '<div class="loader">Ø¬Ø§Ø±Ù ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª...</div>'; }

  try{
    const fresh = await fetchProductsFromApi();
    const changed = !hasCache || JSON.stringify(fresh)!==JSON.stringify(products);
    products = fresh;
    saveProductsCache(fresh);
    if(changed) renderCatalog();
    renderCatalog();
  }catch(err){
    console.error(err);
    statusArea.innerHTML = `<div class="errorBox">Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª. ØªØ£ÙƒØ¯ Ù…Ù† Ù†Ø´Ø± Ø§Ù„Ù€ API. <button id="retryFetch" class="retryBtn">Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©</button></div>`;
    document.getElementById('retryFetch')?.addEventListener('click', ()=>{ statusArea.innerHTML=''; hydrateProducts(); });
    if(!hasCache) elGrid.innerHTML = `<div class="empty">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ø¹Ø±Ø¶ Ø­Ø§Ù„ÙŠØ§Ù‹.</div>`;
    else showToast("Ø¹Ø±Ø¶ Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ù…Ø®Ø²Ù†Ø© Ù…Ø­Ù„ÙŠØ§Ù‹.");
  }
  updateCartBadge();
}

/* search debounce */
const onSearch = debounce((val)=>{ state.q = val; renderCatalog(); }, 220);
elQ.addEventListener('input', e=> onSearch(e.target.value));
elCat.addEventListener('change', e=>{ state.cat = e.target.value; renderCatalog(); });

/* helper to populate categories */
function renderCats(){
  const cats = Array.from(new Set(products.map(p=>p.category))).filter(Boolean).sort();
  elCat.innerHTML = `<option value="">ÙƒÙ„ Ø§Ù„ÙØ¦Ø§Øª</option>`; cats.forEach(c=>{ const opt=document.createElement('option'); opt.value=c; opt.textContent=c; elCat.appendChild(opt); });
}

/* setup */
initCartSchema();
hydrateProducts();

/* expose debug helpers */
window.__reloadProducts = hydrateProducts;
window.__products = products;

</script>
</body>
</html>
